"""
–£–º–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä –º–æ–¥–µ–ª–µ–π –¥–ª—è StroiNadzorAI
–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞
"""

import logging
from typing import Dict, Tuple, Optional
import re

logger = logging.getLogger(__name__)


class ModelSelector:
    """
    –ö–ª–∞—Å—Å –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π AI –º–æ–¥–µ–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–ø—Ä–æ—Å–∞
    """

    def __init__(self):
        # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
        self.technical_keywords = [
            "—Ä–∞—Å—á–µ—Ç", "—Ä–∞—Å—á—ë—Ç", "—Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å", "—Ä–∞—Å—Å—á–∏—Ç–∞–π", "–ø—Ä–æ—á–Ω–æ—Å—Ç—å", "–Ω–µ—Å—É—â–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å",
            "–∞—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ", "–Ω–∞–≥—Ä—É–∑–∫–∞", "–º–æ–º–µ–Ω—Ç", "–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ",
            "–¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è", "–æ—Å–∞–¥–∫–∞", "—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å", "—Ä–∞—Å—á—ë—Ç–Ω",
            "–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç", "–º–æ–¥—É–ª—å —É–ø—Ä—É–≥–æ—Å—Ç–∏", "–∏–∑–≥–∏–±", "—Å–∂–∞—Ç–∏–µ",
            "—Ä–∞—Å—Ç—è–∂–µ–Ω–∏–µ", "—Å–¥–≤–∏–≥", "–∫—Ä—É—Ç—è—â–∏–π –º–æ–º–µ–Ω—Ç"
        ]

        # –ü—Ä–æ—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (–ù–ï —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ)
        self.simple_question_patterns = [
            "—á—Ç–æ —Ç–∞–∫–æ–µ", "–∫—Ç–æ —Ç–∞–∫–æ–π", "—Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ", "–æ–±—ä—è—Å–Ω–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏",
            "–≤ —á—ë–º —Ä–∞–∑–Ω–∏—Ü–∞", "—á–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è"
        ]

        self.legal_keywords = [
            "–¥–æ–≥–æ–≤–æ—Ä", "—Å—É–¥", "–ø—Ä–µ—Ç–µ–Ω–∑–∏—è", "–∏—Å–∫", "–∑–∞–∫–æ–Ω",
            "–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å", "—à—Ç—Ä–∞—Ñ", "–ø—Ä–∞–≤–∞", "–æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏",
            "–∫–æ–∞–ø", "–∫–æ–¥–µ–∫—Å", "—Å—Ç–∞—Ç—å—è", "–Ω–∞—Ä—É—à–µ–Ω–∏–µ", "–∂–∞–ª–æ–±–∞",
            "–∞—Ä–±–∏—Ç—Ä–∞–∂", "—Å—É–¥–µ–±–Ω", "—é—Ä–∏–¥–∏—á–µ—Å–∫"
        ]

        self.drawing_keywords = [
            "–Ω–∞—Ä–∏—Å—É–π", "—Å—Ö–µ–º—É", "—á–µ—Ä—Ç–µ–∂", "–ø–ª–∞–Ω", "–ø–æ–∫–∞–∂–∏ –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç",
            "–≤–∏–∑—É–∞–ª–∏–∑", "–∏–∑–æ–±—Ä–∞–∑–∏", "—Å–¥–µ–ª–∞–π —Ä–∏—Å—É–Ω–æ–∫", "—Å–æ–∑–¥–∞–π –∫–∞—Ä—Ç–∏–Ω–∫—É",
            "—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π", "–ø—Ä–∏—Å–ª–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É", "–æ—Ç–ø—Ä–∞–≤—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ",
            "–ø–æ–∫–∞–∂–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É", "–Ω—É–∂–Ω–∞ —Å—Ö–µ–º–∞", "–Ω—É–∂–µ–Ω –ø–ª–∞–Ω"
        ]

        self.web_search_keywords = [
            "—Ü–µ–Ω–∞", "—Å—Ç–æ–∏–º–æ—Å—Ç—å", "–∞–∫—Ç—É–∞–ª—å–Ω–æ", "2025", "2026", "2027",
            "–Ω–æ–≤–æ—Å—Ç–∏", "–∏–∑–º–µ–Ω–µ–Ω–∏—è", "–ø–æ—Å–ª–µ–¥–Ω–∏–µ", "—Å–≤–µ–∂–∏–µ", "–Ω–æ–≤—ã–π",
            "–¥–µ–π—Å—Ç–≤—É–µ—Ç", "–æ—Ç–º–µ–Ω–µ–Ω", "–ø—Ä–æ–≤–µ—Ä—å", "–Ω–∞–π–¥–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ",
            "—Å–µ–π—á–∞—Å", "—Å–µ–≥–æ–¥–Ω—è", "–≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è", "–Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç"
        ]

        self.defect_keywords = [
            "—Ç—Ä–µ—â–∏–Ω–∞", "–¥–µ—Ñ–µ–∫—Ç", "—Ä–∞–∑—Ä—É—à–µ–Ω–∏–µ", "–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ",
            "–∫–æ—Ä—Ä–æ–∑–∏—è", "–≤–ª–∞–≥–∞", "–ø–ª–µ—Å–µ–Ω—å", "–≥—Ä–∏–±–æ–∫",
            "–æ—Ç—Å–ª–æ–µ–Ω–∏–µ", "–≤—ã–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ", "—á—Ç–æ —Å", "–ø–æ—á–µ–º—É"
        ]

    def classify_request(
        self,
        question: str,
        has_photo: bool = False,
        conversation_context: Optional[list] = None
    ) -> Dict[str, any]:
        """
        –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∏ –≤—ã–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å

        Args:
            question: –¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            has_photo: –ï—Å—Ç—å –ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–µ —Ñ–æ—Ç–æ
            conversation_context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

        Returns:
            Dict —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π:
            {
                "model": "grok_general" | "claude_technical" | "claude_legal" |
                         "claude_dalle" | "gemini_vision",
                "reason": "–∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞",
                "needs_web_search": True/False,
                "priority": "high" | "medium" | "low",
                "estimated_cost": float (–≤ —Ü–µ–Ω—Ç–∞—Ö)
            }
        """
        question_lower = question.lower()

        # 1. –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ ‚Üí Gemini Vision (–¥—ë—à–µ–≤–æ + –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ)
        if has_photo:
            is_defect = any(kw in question_lower for kw in self.defect_keywords)

            if is_defect:
                return {
                    "model": "gemini_vision",
                    "reason": "–ê–Ω–∞–ª–∏–∑ –¥–µ—Ñ–µ–∫—Ç–∞ –Ω–∞ —Ñ–æ—Ç–æ (Gemini Vision –¥–µ—à–µ–≤–ª–µ –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–µ–µ)",
                    "needs_web_search": False,
                    "priority": "high",
                    "estimated_cost": 0.15  # Gemini Flash –æ—á–µ–Ω—å –¥—ë—à–µ–≤
                }
            else:
                return {
                    "model": "grok_vision",
                    "reason": "–ü—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ (Grok –±–µ—Å–ø–ª–∞—Ç–Ω–æ)",
                    "needs_web_search": False,
                    "priority": "medium",
                    "estimated_cost": 0.0
                }

        # 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä—Ç–µ–∂–µ–π ‚Üí Claude (–ª—É—á—à–µ –∑–Ω–∞–µ—Ç –ì–û–°–¢) + DALL-E
        if any(kw in question_lower for kw in self.drawing_keywords):
            return {
                "model": "claude_dalle",
                "reason": "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ —á–µ—Ä—Ç–µ–∂–∞ (Claude —Å–æ–∑–¥–∞—ë—Ç –ø—Ä–æ–º–ø—Ç –ø–æ –ì–û–°–¢)",
                "needs_web_search": False,
                "priority": "medium",
                "estimated_cost": 5.0  # Claude –ø—Ä–æ–º–ø—Ç (1 —Ü–µ–Ω—Ç) + DALL-E (4 —Ü–µ–Ω—Ç–∞)
            }

        # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (–¥–∞–∂–µ –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–≤–∞)
        is_simple = any(pattern in question_lower for pattern in self.simple_question_patterns)

        # 4. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã (—Ä–∞—Å—á—ë—Ç—ã, –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –Ω–æ—Ä–º–∞—Ç–∏–≤—ã) ‚Üí Claude
        is_technical = (
            any(kw in question_lower for kw in self.technical_keywords) or
            any(kw in question_lower for kw in self.legal_keywords) or
            self._mentions_regulations(question) or
            self._is_technical_question(question)
        )

        # –ï—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ–π –≤–æ–ø—Ä–æ—Å - –∏—Å–ø–æ–ª—å–∑—É–µ–º Grok –¥–∞–∂–µ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–≤–∞
        if is_simple:
            return {
                "model": "grok_general",
                "reason": "–ü—Ä–æ—Å—Ç–æ–π –≤–æ–ø—Ä–æ—Å (Grok –±–µ—Å–ø–ª–∞—Ç–Ω–æ)",
                "needs_web_search": False,
                "priority": "low",
                "estimated_cost": 0.0
            }

        if is_technical:
            return {
                "model": "claude_technical",
                "reason": "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å (Claude Sonnet 4.5 –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞)",
                "needs_web_search": self._mentions_regulations(question),
                "priority": "high",
                "estimated_cost": 3.0
            }

        # 4. –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–ª–∏ –ø—Ä–æ—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã ‚Üí Grok
        needs_search = any(kw in question_lower for kw in self.web_search_keywords)

        return {
            "model": "grok_general",
            "reason": "–û–±—â–∏–π –≤–æ–ø—Ä–æ—Å (Grok –±–µ—Å–ø–ª–∞—Ç–Ω–æ)" if not needs_search else "–ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (Grok —Å web search)",
            "needs_web_search": needs_search,
            "priority": "low",
            "estimated_cost": 0.0
        }

    def _is_technical_question(self, question: str) -> bool:
        """
        –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–æ–ø—Ä–æ—Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É

        Returns:
            True –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π
        """
        technical_context_keywords = [
            "–±–µ—Ç–æ–Ω", "—Ñ—É–Ω–¥–∞–º–µ–Ω—Ç", "–ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ", "—Å—Ç–µ–Ω–∞", "–ø–ª–∏—Ç–∞",
            "–∞—Ä–º–∞—Ç—É—Ä–∞", "–∫–ª–∞—Å—Å", "–º–∞—Ä–∫–∞", "—Ç–æ–ª—â–∏–Ω–∞", "–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏",
            "—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è", "–Ω–æ—Ä–º—ã", "—Å—Ç–∞–Ω–¥–∞—Ä—Ç", "–ø—Ä–∞–≤–∏–ª",
            "–∫–∞–∫–æ–π", "—Å–∫–æ–ª—å–∫–æ", "–∫–∞–∫ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å", "–Ω—É–∂–Ω–æ –ª–∏",
            "–º–æ–∂–Ω–æ –ª–∏", "–¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è", "–º–∞—Ç–µ—Ä–∏–∞–ª", "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è"
        ]

        question_lower = question.lower()
        return any(kw in question_lower for kw in technical_context_keywords)

    def _mentions_regulations(self, question: str) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —É–ø–æ–º–∏–Ω–∞—é—Ç—Å—è –ª–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

        Returns:
            True –µ—Å–ª–∏ –µ—Å—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –°–ü, –ì–û–°–¢, –°–ù–∏–ü –∏ —Ç.–ø.
        """
        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤
        patterns = [
            r'–°–ü\s+[\d.]+',  # –°–ü 63.13330.2018
            r'–ì–û–°–¢\s+[–†–ï\s]*[\d.-]+',  # –ì–û–°–¢ 31937-2011
            r'–°–ù–∏–ü\s+[\d.-]+',  # –°–ù–∏–ü 2.01.07-85
            r'–ü–ü–ë\s+[\d-]+',  # –ü–ü–ë 01-03
            r'–§–ó\s+‚Ññ?\d+',  # –§–ó ‚Ññ384
            r'–ü–ü\s+‚Ññ?\d+',  # –ü–ü ‚Ññ87
        ]

        for pattern in patterns:
            if re.search(pattern, question, re.IGNORECASE):
                return True

        return False

    def get_statistics(self, decisions: list) -> Dict:
        """
        –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π

        Args:
            decisions: –°–ø–∏—Å–æ–∫ —Ä–µ—à–µ–Ω–∏–π classify_request

        Returns:
            –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ –∑–∞—Ç—Ä–∞—Ç
        """
        stats = {
            "total_requests": len(decisions),
            "by_model": {},
            "total_cost": 0.0,
            "avg_cost": 0.0
        }

        for decision in decisions:
            model = decision["model"]
            cost = decision["estimated_cost"]

            if model not in stats["by_model"]:
                stats["by_model"][model] = {
                    "count": 0,
                    "cost": 0.0
                }

            stats["by_model"][model]["count"] += 1
            stats["by_model"][model]["cost"] += cost
            stats["total_cost"] += cost

        if len(decisions) > 0:
            stats["avg_cost"] = stats["total_cost"] / len(decisions)

        return stats


# ============================================================================
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
# ============================================================================

def should_use_web_search(question: str) -> bool:
    """
    –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –Ω—É–∂–µ–Ω –ª–∏ web search –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞

    Args:
        question: –¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞

    Returns:
        True –µ—Å–ª–∏ –Ω—É–∂–µ–Ω web search
    """
    web_search_triggers = [
        "–∞–∫—Ç—É–∞–ª—å–Ω–æ", "2025", "2026", "2027",
        "—Ü–µ–Ω–∞", "—Å—Ç–æ–∏–º–æ—Å—Ç—å", "–Ω–æ–≤–æ—Å—Ç–∏", "–∏–∑–º–µ–Ω–µ–Ω–∏—è",
        "–ø–æ—Å–ª–µ–¥–Ω–∏–µ", "—Å–≤–µ–∂–∏–µ", "–¥–µ–π—Å—Ç–≤—É–µ—Ç", "–æ—Ç–º–µ–Ω–µ–Ω",
        "–ø—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å", "–Ω–∞–π–¥–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ",
        "—Å–µ–π—á–∞—Å", "—Å–µ–≥–æ–¥–Ω—è", "–≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è", "–Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç"
    ]

    question_lower = question.lower()
    return any(trigger in question_lower for trigger in web_search_triggers)


def extract_regulation_codes(text: str) -> list:
    """
    –ò–∑–≤–ª–µ—á—å –∫–æ–¥—ã –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤ –∏–∑ —Ç–µ–∫—Å—Ç–∞

    Args:
        text: –¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

    Returns:
        List –∫–æ–¥–æ–≤ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤
    """
    patterns = [
        r'–°–ü\s+[\d.]+\.[\d.]+',  # –°–ü 63.13330.2018
        r'–ì–û–°–¢\s+[–†–ï\s]*[\d.-]+',  # –ì–û–°–¢ 31937-2011
        r'–°–ù–∏–ü\s+[\d.-]+',  # –°–ù–∏–ü 2.01.07-85
        r'–ü–ü–ë\s+[\d-]+',  # –ü–ü–ë 01-03
    ]

    codes = []
    for pattern in patterns:
        matches = re.findall(pattern, text, re.IGNORECASE)
        codes.extend(matches)

    # –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
    return list(set(codes))


# ============================================================================
# –ü–†–ò–ú–ï–†–´ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø
# ============================================================================

if __name__ == "__main__":
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞
    selector = ModelSelector()

    # –ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤
    test_questions = [
        ("–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —Ü–µ–º–µ–Ω—Ç –ú400 –≤ –ú–æ—Å–∫–≤–µ?", False),
        ("–†–∞—Å—Å—á–∏—Ç–∞–π –∞—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∏—Ç—ã –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è 6x6–º", False),
        ("–ù–∞ —Ñ–æ—Ç–æ —Ç—Ä–µ—â–∏–Ω–∞ –≤ —Å—Ç–µ–Ω–µ, —á—Ç–æ —ç—Ç–æ?", True),
        ("–ù–∞—Ä–∏—Å—É–π —Å—Ö–µ–º—É —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞ –ø–æ–¥ –¥–æ–º 10x12", False),
        ("–ê–∫—Ç—É–∞–ª–µ–Ω –ª–∏ –°–ü 63.13330.2018?", False),
        ("–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∫–ª–∞—Å—Ç—å –∫–∏—Ä–ø–∏—á?", False),
    ]

    print("=" * 60)
    print("–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ö–õ–ê–°–°–ò–§–ò–ö–ê–¢–û–†–ê –ó–ê–ü–†–û–°–û–í")
    print("=" * 60)

    decisions = []

    for question, has_photo in test_questions:
        decision = selector.classify_request(question, has_photo)
        decisions.append(decision)

        print(f"\nüìù –í–æ–ø—Ä–æ—Å: {question}")
        if has_photo:
            print("   üì∏ –° —Ñ–æ—Ç–æ")
        print(f"ü§ñ –ú–æ–¥–µ–ª—å: {decision['model']}")
        print(f"üí° –ü—Ä–∏—á–∏–Ω–∞: {decision['reason']}")
        print(f"üåê Web search: {'–î–∞' if decision['needs_web_search'] else '–ù–µ—Ç'}")
        print(f"üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: ${decision['estimated_cost']:.3f}")

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    stats = selector.get_statistics(decisions)

    print("\n" + "=" * 60)
    print("–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø")
    print("=" * 60)
    print(f"\n–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: {stats['total_requests']}")
    print(f"–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${stats['total_cost']:.2f}")
    print(f"–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${stats['avg_cost']:.3f}")

    print("\n–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –º–æ–¥–µ–ª—è–º:")
    for model, data in stats["by_model"].items():
        percent = (data["count"] / stats["total_requests"]) * 100
        print(f"  {model}: {data['count']} ({percent:.1f}%) - ${data['cost']:.2f}")
