"""
–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è AI –¥–ª—è –°—Ç—Ä–æ–π–ù–∞–¥–∑–æ—ÄAI v5.0
=======================================================

–°—Ç—Ä–∞—Ç–µ–≥–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API:
1. FAQ/–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ ‚Üí –ë–ï–ó AI (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
2. –ü—Ä–æ—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã ‚Üí Grok 2 (–±—ã—Å—Ç—Ä–æ, –¥—ë—à–µ–≤–æ)
3. –°–ª–æ–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã ‚Üí Grok 3 –∏–ª–∏ Claude (–∫–∞—á–µ—Å—Ç–≤–æ)
4. –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ ‚Üí Gemini 2.5 Flash (–¥—ë—à–µ–≤–æ)
5. –ü–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ ‚Üí Grok —Å live_search
6. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä—Ç–µ–∂–µ–π ‚Üí DALL-E 3 (HD –∫–∞—á–µ—Å—Ç–≤–æ)

–ê–≤—Ç–æ—Ä: –°—Ç—Ä–æ–π–ù–∞–¥–∑–æ—ÄAI Team
–í–µ—Ä—Å–∏—è: 5.0 (–¥–µ–∫–∞–±—Ä—å 2025)
"""

import re
import logging
from typing import Dict, List, Optional, Tuple
from enum import Enum

logger = logging.getLogger(__name__)


# ============================================================================
# –ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–Ø –ó–ê–ü–†–û–°–û–í
# ============================================================================

class QueryType(Enum):
    """–¢–∏–ø—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏"""
    FAQ = "faq"                    # –ü—Ä–æ—Å—Ç–æ–π –≤–æ–ø—Ä–æ—Å –∏–∑ FAQ ‚Üí –±–µ–∑ AI
    CALCULATOR = "calculator"      # –†–∞—Å—á—ë—Ç ‚Üí –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
    REGULATION = "regulation"      # –ù–æ—Ä–º–∞—Ç–∏–≤ ‚Üí –ø–æ–∏—Å–∫ + AI
    PRACTICAL = "practical"        # –ü—Ä–∞–∫—Ç–∏–∫–∞ ‚Üí —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ + AI
    TECHNICAL = "technical"        # –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π ‚Üí Grok 3
    LEGAL = "legal"               # –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π ‚Üí Grok 3
    IMAGE_ANALYZE = "image"        # –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ ‚Üí Gemini
    IMAGE_GENERATE = "generate"    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ‚Üí DALL-E
    WEB_SEARCH = "search"          # –ü–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ ‚Üí Grok
    GENERAL = "general"            # –û–±—â–∏–π ‚Üí Grok 2


class AIModel(Enum):
    """–î–æ—Å—Ç—É–ø–Ω—ã–µ AI –º–æ–¥–µ–ª–∏"""
    GROK_2 = "grok-2-latest"       # –ë—ã—Å—Ç—Ä—ã–π, –¥–µ—à—ë–≤—ã–π
    GROK_3 = "grok-3"              # –ú–æ—â–Ω—ã–π, —Å reasoning
    CLAUDE_SONNET = "claude-sonnet-4-5-20250929"  # Anthropic
    GEMINI_FLASH = "gemini-2.5-flash"  # –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    DALLE_3 = "dall-e-3"           # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π


# ============================================================================
# –ú–ê–†–®–†–£–¢–ò–ó–ê–¢–û–† –ó–ê–ü–†–û–°–û–í (—ç–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤)
# ============================================================================

# –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞
QUERY_PATTERNS = {
    QueryType.FAQ: [
        r"—á—Ç–æ —Ç–∞–∫–æ–µ (—Å–Ω–∏–ø|–≥–æ—Å—Ç|—Å–ø\s|—Ñ–∑\s|–Ω–æ—Ä–º–∞—Ç)",
        r"—Ä–∞—Å—à–∏—Ñ—Ä—É–π|–æ–±—ä—è—Å–Ω–∏.*(—Ç–µ—Ä–º–∏–Ω|–ø–æ–Ω—è—Ç–∏–µ|–∞–±–±—Ä–µ–≤–∏–∞—Ç)",
        r"—á–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è.*–æ—Ç",
        r"–∫–∞–∫–∞—è —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É",
        r"–ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏",
    ],
    QueryType.CALCULATOR: [
        r"(—Ä–∞—Å—Å—á–∏—Ç|–ø–æ—Å—á–∏—Ç|—Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ|—Ä–∞—Å—Ö–æ–¥|–æ–±—ä—ë–º|–∫–æ–ª–∏—á–µ—Å—Ç–≤)",
        r"–∫–∞–ª—å–∫—É–ª",
        r"\d+\s*(–º2|–º3|–º–º|—Å–º|–º–µ—Ç—Ä|–∫–≥|—Ç–æ–Ω–Ω)",
        r"(–±–µ—Ç–æ–Ω|–∞—Ä–º–∞—Ç—É—Ä|–∫–∏—Ä–ø–∏—á|–ø–ª–∏—Ç–∫|—à—Ç—É–∫–∞—Ç—É—Ä–∫|–∫—Ä–∞—Å–∫).*(—Ä–∞—Å—Å—á–∏—Ç|–ø–æ—Å—á–∏—Ç)",
    ],
    QueryType.REGULATION: [
        r"(—Å–ø|–≥–æ—Å—Ç|—Å–Ω–∏–ø|—Ñ–∑|–ø–ø)\s*[\d\.]+",
        r"(–Ω–æ—Ä–º–∞—Ç–∏–≤|—Ç—Ä–µ–±–æ–≤–∞–Ω–∏|–¥–æ–ø—É—Å–∫|–ø—Ä–∞–≤–∏–ª|—Å—Ç–∞–Ω–¥–∞—Ä—Ç)",
        r"(—Å—Å—ã–ª–∫|–ø—É–Ω–∫—Ç|—Å—Ç–∞—Ç—å—è|–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)",
        r"(–¥–µ–π—Å—Ç–≤—É—é—â|–∞–∫—Ç—É–∞–ª—å–Ω|–æ–±—è–∑–∞—Ç–µ–ª—å–Ω)",
        r"(–º–∏–Ω—Å—Ç—Ä–æ|–≥—Ä–∞–¥–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω|—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Ä–µ–≥–ª–∞–º–µ–Ω—Ç)",
    ],
    QueryType.PRACTICAL: [
        r"(–∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ|–∫–∞–∫ –¥–µ–ª–∞—Ç—å|–∫–∞–∫ –≤—ã–ø–æ–ª–Ω|—Ç–µ—Ö–Ω–æ–ª–æ–≥)",
        r"(–ø–æ—à–∞–≥–æ–≤|–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏|–ø–æ—Ä—è–¥–æ–∫ —Ä–∞–±–æ—Ç)",
        r"(–Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ|–Ω–∞ –ø–ª–æ—â–∞–¥–∫–µ|–Ω–∞ –æ–±—ä–µ–∫—Ç–µ)",
        r"(–±–µ—Ç–æ–Ω–∏—Ä–æ–≤|–∞—Ä–º–∏—Ä–æ–≤|–æ–ø–∞–ª—É–±–∫|–∫–ª–∞–¥–∫|—à—Ç—É–∫–∞—Ç—É—Ä|–ø–æ–∫—Ä–∞—Å–∫)",
        r"(—Å–≤–æ–∏–º–∏ —Ä—É–∫–∞–º–∏|—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ)",
    ],
    QueryType.TECHNICAL: [
        r"(—Ä–∞—Å—á—ë—Ç|–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω|–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏|–Ω–∞–≥—Ä—É–∑–∫|–ø—Ä–æ—á–Ω–æ—Å—Ç)",
        r"(–∞—Ä–º–∏—Ä–æ–≤–∞–Ω|—Ñ—É–Ω–¥–∞–º–µ–Ω—Ç|–ø–µ—Ä–µ–∫—Ä—ã—Ç–∏|–∫–æ–ª–æ–Ω–Ω|–±–∞–ª–∫)",
        r"(—É–∑–µ–ª|–¥–µ—Ç–∞–ª—å|—Å–æ–ø—Ä—è–∂–µ–Ω|—Å–æ–µ–¥–∏–Ω–µ–Ω)",
        r"(–º–∞—Ä–∫|–∫–ª–∞—Å|–ø—Ä–æ—á–Ω–æ—Å—Ç|–º–æ–¥—É–ª—å|–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç)",
    ],
    QueryType.LEGAL: [
        r"(–¥–æ–≥–æ–≤–æ—Ä|–∫–æ–Ω—Ç—Ä–∞–∫—Ç|–ø—Ä–µ—Ç–µ–Ω–∑–∏|–Ω–µ—É—Å—Ç–æ–π–∫|—à—Ç—Ä–∞—Ñ)",
        r"(–∞–∫—Ç|–∫—Å-2|–∫—Å-3|–∂—É—Ä–Ω–∞–ª|–ø—Ä–æ—Ç–æ–∫–æ–ª)",
        r"(—Å—É–¥|–∞—Ä–±–∏—Ç—Ä–∞–∂|–∏—Å–∫|–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç)",
        r"(–∑–∞–∫–∞–∑—á–∏–∫|–ø–æ–¥—Ä—è–¥—á–∏–∫|—Å—É–±–ø–æ–¥—Ä—è–¥—á–∏–∫)",
        r"(–æ–ø–ª–∞—Ç|–∞–≤–∞–Ω—Å|–≥–∞—Ä–∞–Ω—Ç–∏–π–Ω)",
    ],
    QueryType.IMAGE_GENERATE: [
        r"(–Ω–∞—Ä–∏—Å—É|–ø–æ–∫–∞–∂–∏|—Å–≥–µ–Ω–µ—Ä–∏—Ä|–≤–∏–∑—É–∞–ª–∏–∑|—Å–æ–∑–¥–∞–π)",
        r"(—á–µ—Ä—Ç—ë–∂|—Å—Ö–µ–º|–ø–ª–∞–Ω|—Ä–∞–∑—Ä–µ–∑|—É–∑–µ–ª|–¥–µ—Ç–∞–ª—å)",
        r"(–∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç|–∏–∑–æ–±—Ä–∞–∂–µ–Ω)",
    ],
    QueryType.WEB_SEARCH: [
        r"(–Ω–∞–π–¥–∏|–ø–æ–∏—â–∏|–∞–∫—Ç—É–∞–ª—å–Ω|–ø–æ—Å–ª–µ–¥–Ω|—Å–≤–µ–∂–∏|–Ω–æ–≤–æ—Å—Ç)",
        r"(2024|2025|2026|–Ω–∞ —Å–µ–≥–æ–¥–Ω—è|—Å–µ–π—á–∞—Å)",
        r"(—Ü–µ–Ω|—Å—Ç–æ–∏–º–æ—Å—Ç|—Ç–∞—Ä–∏—Ñ|–∫—É—Ä—Å)",
        r"(–∏–∑–º–µ–Ω–µ–Ω|–æ–±–Ω–æ–≤–ª–µ–Ω|—Ä–µ–¥–∞–∫—Ü–∏)",
    ],
}


def classify_query(text: str) -> Tuple[QueryType, float]:
    """
    –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ AI

    Returns:
        Tuple[QueryType, float]: –¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (0-1)
    """
    text_lower = text.lower()
    scores = {}

    for query_type, patterns in QUERY_PATTERNS.items():
        score = 0
        for pattern in patterns:
            if re.search(pattern, text_lower):
                score += 1
        if score > 0:
            scores[query_type] = score / len(patterns)

    if not scores:
        return QueryType.GENERAL, 0.5

    best_type = max(scores, key=scores.get)
    return best_type, scores[best_type]


def get_optimal_model(query_type: QueryType, has_image: bool = False) -> AIModel:
    """
    –í—ã–±–∏—Ä–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å –¥–ª—è —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞

    –°—Ç—Ä–∞—Ç–µ–≥–∏—è —ç–∫–æ–Ω–æ–º–∏–∏:
    - FAQ, –ø—Ä–æ—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã ‚Üí Grok 2 (–¥–µ—à–µ–≤–ª–µ)
    - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ, —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ ‚Üí Grok 3 (–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–µ–µ)
    - –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ ‚Üí Gemini Flash (—Å–∞–º—ã–π –¥–µ—à—ë–≤—ã–π –¥–ª—è vision)
    """
    if has_image:
        return AIModel.GEMINI_FLASH

    model_map = {
        QueryType.FAQ: AIModel.GROK_2,
        QueryType.CALCULATOR: AIModel.GROK_2,
        QueryType.GENERAL: AIModel.GROK_2,
        QueryType.PRACTICAL: AIModel.GROK_2,
        QueryType.REGULATION: AIModel.GROK_3,
        QueryType.TECHNICAL: AIModel.GROK_3,
        QueryType.LEGAL: AIModel.GROK_3,
        QueryType.WEB_SEARCH: AIModel.GROK_3,
        QueryType.IMAGE_GENERATE: AIModel.DALLE_3,
    }

    return model_map.get(query_type, AIModel.GROK_2)


# ============================================================================
# –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–¢
# ============================================================================

SYSTEM_PROMPT_OPTIMIZED = """–í—ã ‚Äî ¬´–°—Ç—Ä–æ–π–ù–∞–¥–∑–æ—ÄAI¬ª v5.0, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π Telegram‚Äë–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É –≤ –†–§.

üéØ –ì–õ–ê–í–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´:
1. –ö–†–ê–¢–ö–û–°–¢–¨ ‚Äî —Ü–µ–Ω–∏—Ç—Å—è –≤—Ä–µ–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–µ –ª–µ–π –≤–æ–¥—É
2. –¢–û–ß–ù–û–°–¢–¨ ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
3. –ü–†–ê–ö–¢–ò–ß–ù–û–°–¢–¨ ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, –∞ –Ω–µ —Ç–µ–æ—Ä–∏—è
4. –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ ‚Äî –≤—Å–µ–≥–¥–∞ –Ω–∞ –ø–µ—Ä–≤–æ–º –º–µ—Å—Ç–µ

üì± –§–û–†–ú–ê–¢ –î–õ–Ø –¢–ï–õ–ï–§–û–ù–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):
‚Ä¢ –ú–∞–∫—Å–∏–º—É–º 35 —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Å—Ç—Ä–æ–∫–µ
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –∑–∞–≥–æ–ª–æ–≤–æ–∫ ‚Üí –±—É–ª–ª–µ—Ç—ã ‚Üí –∏—Ç–æ–≥
‚Ä¢ –í–º–µ—Å—Ç–æ —Ç–∞–±–ª–∏—Ü ‚Äî –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ —Å–ø–∏—Å–∫–∏
‚Ä¢ –≠–º–æ–¥–∑–∏ –≤ –Ω–∞—á–∞–ª–µ —Ä–∞–∑–¥–µ–ª–æ–≤ (üìå üîß ‚úÖ ‚ö†Ô∏è)
‚Ä¢ –°—Ö–µ–º—ã —Ç–æ–ª—å–∫–æ —É–∑–∫–∏–µ (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ)

üìå –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:
1. **–°—É—Ç—å** (1-2 —Å—Ç—Ä–æ–∫–∏ ‚Äî –≥–ª–∞–≤–Ω–æ–µ)
2. **–î–µ—Ç–∞–ª–∏** (–±—É–ª–ª–µ—Ç—ã –ø–æ –ø—É–Ω–∫—Ç–∞–º)
3. **–î–µ–π—Å—Ç–≤–∏—è** (—á—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –¥–µ–ª–∞—Ç—å)
4. **–ö–æ–Ω—Ç—Ä–æ–ª—å** (–∫–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç)
5. **–í–æ–ø—Ä–æ—Å** (1 —É—Ç–æ—á–Ω—è—é—â–∏–π, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

üåê –ü–û–ò–°–ö –í –ò–ù–¢–ï–†–ù–ï–¢–ï:
‚Ä¢ –ï—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã live_search (web, news, x)
‚Ä¢ –ò–°–ü–û–õ–¨–ó–£–ô –¥–ª—è: —Ü–µ–Ω, –¥–∞—Ç, –Ω–æ–≤–æ—Å—Ç–µ–π, –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ä–µ–¥–∞–∫—Ü–∏–π
‚Ä¢ –ü–æ—Å–ª–µ –ø–æ–∏—Å–∫–∞ –¥–æ–±–∞–≤—å –±–ª–æ–∫ ¬´üåê –ò—Å—Ç–æ—á–Ω–∏–∫–∏:¬ª —Å–æ —Å—Å—ã–ª–∫–∞–º–∏

üìö –ù–û–†–ú–ê–¢–ò–í–´ –ò –°–°–´–õ–ö–ò:
‚Ä¢ –ù–ï –¥–æ–±–∞–≤–ª—è–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ¬´–¥–ª—è —Å–æ–ª–∏–¥–Ω–æ—Å—Ç–∏¬ª
‚Ä¢ –î–æ–±–∞–≤–ª—è–π –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç
‚Ä¢ –§–æ—Ä–º–∞—Ç: –°–ü 63.13330.2018, –ø. 8.2.1

üß† –ó–ê–©–ò–¢–ê –û–¢ –ì–ê–õ–õ–Æ–¶–ò–ù–ê–¶–ò–ô:
‚Ä¢ –ù–µ –∑–Ω–∞–µ—à—å —Ç–æ—á–Ω–æ ‚Üí —Å–∫–∞–∂–∏ —á–µ—Å—Ç–Ω–æ
‚Ä¢ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Üí –∑–∞–¥–∞–π 2-3 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞
‚Ä¢ –£—Å—Ç–∞—Ä–µ–≤—à–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ–∏—Å–∫–∞—Ç—å

‚ö†Ô∏è –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ (–Ω–∞—á–∏–Ω–∞–π —Å —ç—Ç–æ–≥–æ –µ—Å–ª–∏):
‚Ä¢ –†–∞–±–æ—Ç—ã –Ω–∞ –≤—ã—Å–æ—Ç–µ (>1.8–º)
‚Ä¢ –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ, –≥–∞–∑
‚Ä¢ –ö–æ—Ç–ª–æ–≤–∞–Ω—ã, –∫—Ä–∞–Ω–æ–≤—ã–µ —Ä–∞–±–æ—Ç—ã
‚Ä¢ –ü–æ–∂–∞—Ä–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

üîß –ê–î–ê–ü–¢–ê–¶–ò–Ø –ü–û–î –ó–ê–ü–†–û–°:
A) ¬´–ß—Ç–æ –¥–µ–ª–∞—Ç—å?¬ª ‚Üí —á–µ–∫-–ª–∏—Å—Ç + –ø–æ—Ä—è–¥–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
B) ¬´–ö–∞–∫ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å?¬ª ‚Üí —Ñ–æ—Ä–º—É–ª–∞ + –ø—Ä–∏–º–µ—Ä —Å —Ü–∏—Ñ—Ä–∞–º–∏
C) ¬´–ö–∞–∫–æ–π –Ω–æ—Ä–º–∞—Ç–∏–≤?¬ª ‚Üí –¥–æ–∫—É–º–µ–Ω—Ç + –ø—É–Ω–∫—Ç + live_search
D) ¬´–î–µ—Ñ–µ–∫—Ç/–ø—Ä–æ–±–ª–µ–º–∞¬ª ‚Üí –ø—Ä–∏—á–∏–Ω–∞ + —Ä–µ—à–µ–Ω–∏–µ + –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞
E) ¬´–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π¬ª ‚Üí —Ä–∏—Å–∫–∏ + —á—Ç–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø–∏—Å—å–º–µ–Ω–Ω–æ

üí° –°–ü–†–ê–í–û–ß–ù–ò–ö –°–¢–†–û–ò–¢–ï–õ–Ø (–∏—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏):
‚Ä¢ –ó–µ–º–ª—è–Ω—ã–µ —Ä–∞–±–æ—Ç—ã, —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç—ã
‚Ä¢ –ö–∞–º–µ–Ω–Ω–∞—è –∫–ª–∞–¥–∫–∞, —à—Ç—É–∫–∞—Ç—É—Ä–∫–∞
‚Ä¢ –ö—Ä–æ–≤–ª—è, –≥–∏–¥—Ä–æ–∏–∑–æ–ª—è—Ü–∏—è
‚Ä¢ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

üìê –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†–´ (–Ω–∞–ø—Ä–∞–≤–ª—è–π —Ç—É–¥–∞ –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤):
¬´–î–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /calculators¬ª

üéØ –í–ê–ñ–ù–û ‚Äî –ù–ï –î–ï–õ–ê–ô:
‚ùå –î–ª–∏–Ω–Ω—ã–µ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è
‚ùå –°—Å—ã–ª–∫–∏ –Ω–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤—ã –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞
‚ùå –®–∏—Ä–æ–∫–∏–µ ASCII-—Ç–∞–±–ª–∏—Ü—ã
‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
‚ùå –§—Ä–∞–∑—ã ¬´—ç—Ç–æ —Ö–æ—Ä–æ—à–∏–π –≤–æ–ø—Ä–æ—Å¬ª, ¬´—Ä–∞–¥ –ø–æ–º–æ—á—å¬ª

‚úÖ –î–ï–õ–ê–ô:
‚úì –°—Ä–∞–∑—É –∫ —Å—É—Ç–∏ –≤–æ–ø—Ä–æ—Å–∞
‚úì –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ –¥–µ–π—Å—Ç–≤–∏—è
‚úì –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ —Ä–∏—Å–∫–∞—Ö
‚úì –û–¥–∏–Ω —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –≤ –∫–æ–Ω—Ü–µ"""


# ============================================================================
# –ü–†–û–ú–¢ –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –ß–ï–†–¢–ï–ñ–ï–ô
# ============================================================================

BLUEPRINT_GENERATION_PROMPT = """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –¢–ï–•–ù–ò–ß–ï–°–ö–ò–• –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è DALL-E 3 –≤ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–π —Å—Ñ–µ—Ä–µ.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: —Å–æ–∑–¥–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–û–ì–û –ß–ï–†–¢–ï–ñ–ê –ø–æ –ì–û–°–¢.

üéØ –ö–†–ò–¢–ï–†–ò–ò –ö–ê–ß–ï–°–¢–í–ï–ù–ù–û–ì–û –ß–ï–†–¢–ï–ñ–ê:

1. **–†–ê–ó–ú–ï–†–´ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!):**
   ‚Ä¢ –ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å —Ç–æ—á–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏ –≤ –º–º/–º
   ‚Ä¢ –†–∞–∑–º–µ—Ä–Ω—ã–µ –ª–∏–Ω–∏–∏ —Å–æ —Å—Ç—Ä–µ–ª–∫–∞–º–∏
   ‚Ä¢ –ß–∏—Å–ª–∞ –Ω–∞–¥ –ª–∏–Ω–∏—è–º–∏ (–ì–û–°–¢ 2.307)
   ‚Ä¢ –ü—Ä–∏–º–µ—Ä: "width 600mm, height 1200mm, thickness 400mm"

2. **–¢–ò–ü–´ –õ–ò–ù–ò–ô (–ì–û–°–¢ 2.303):**
   ‚Ä¢ –¢–æ–ª—Å—Ç—ã–µ —Å–ø–ª–æ—à–Ω—ã–µ ‚Äî –∫–æ–Ω—Ç—É—Ä—ã (0.5-1.4mm)
   ‚Ä¢ –¢–æ–Ω–∫–∏–µ —Å–ø–ª–æ—à–Ω—ã–µ ‚Äî —Ä–∞–∑–º–µ—Ä–Ω—ã–µ –ª–∏–Ω–∏–∏
   ‚Ä¢ –®—Ç—Ä–∏—Ö–æ–≤—ã–µ ‚Äî –Ω–µ–≤–∏–¥–∏–º—ã–µ —á–∞—Å—Ç–∏
   ‚Ä¢ –®—Ç—Ä–∏—Ö–ø—É–Ω–∫—Ç–∏—Ä–Ω—ã–µ ‚Äî –æ—Å–∏ —Å–∏–º–º–µ—Ç—Ä–∏–∏

3. **–®–¢–†–ò–•–û–í–ö–ê –ú–ê–¢–ï–†–ò–ê–õ–û–í (–ì–û–°–¢ 2.306):**
   ‚Ä¢ –ë–µ—Ç–æ–Ω: —Ç–æ—á–∫–∏ + —à—Ç—Ä–∏—Ö–∏
   ‚Ä¢ –ú–µ—Ç–∞–ª–ª: –¥–∏–∞–≥–æ–Ω–∞–ª—å 45¬∞
   ‚Ä¢ –ì—Ä—É–Ω—Ç: —Ç—Ä–∏ —Ç–æ—á–∫–∏ + —à—Ç—Ä–∏—Ö
   ‚Ä¢ –î–µ—Ä–µ–≤–æ: –¥—É–≥–∏ (–≤–æ–ª–æ–∫–Ω–∞)
   ‚Ä¢ –ö–∏—Ä–ø–∏—á: –¥–∏–∞–≥–æ–Ω–∞–ª—å –ø–æ–¥ —É–≥–ª–æ–º

4. **–ê–ù–ù–û–¢–ê–¶–ò–ò (–Ω–∞ –†–£–°–°–ö–û–ú):**
   ‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
   ‚Ä¢ –ú–∞—Ä–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (–ú300, A500C)
   ‚Ä¢ –ö–ª–∞—Å—Å—ã –±–µ—Ç–æ–Ω–∞ (B25)
   ‚Ä¢ –î–∏–∞–º–µ—Ç—Ä—ã –∞—Ä–º–∞—Ç—É—Ä—ã (√ò16)

5. **–ú–ê–°–®–¢–ê–ë (–ì–û–°–¢ 2.302):**
   ‚Ä¢ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ: 1:10, 1:20, 1:50, 1:100
   ‚Ä¢ –£–∫–∞–∑–∞–Ω–∏–µ –≤ —É–≥–ª—É —á–µ—Ä—Ç–µ–∂–∞

üìù –§–û–†–ú–ê–¢ –ü–†–û–ú–¢–ê:
[–î–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º]

---–û–ü–ò–°–ê–ù–ò–ï---
[–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º –¥–ª—è Telegram (–º–∞–∫—Å 100 —Å–ª–æ–≤):
‚Ä¢ –ß—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ
‚Ä¢ –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
‚Ä¢ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã
‚Ä¢ –§–æ—Ä–º–∞—Ç –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞: 35 —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Å—Ç—Ä–æ–∫–µ]

‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –í–ö–õ–Æ–ß–ò:
‚Ä¢ professional GOST technical drawing
‚Ä¢ exact measurements in mm/m
‚Ä¢ dimension lines with arrows
‚Ä¢ material hatching patterns
‚Ä¢ Russian labels in technical font
‚Ä¢ clean white background
‚Ä¢ high contrast black lines

üö´ –ù–ï –í–ö–õ–Æ–ß–ê–ô:
‚Ä¢ –§–æ—Ç–æ-—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Å—Ç–∏–ª—å
‚Ä¢ –õ—é–¥–µ–π, –ª–∏—Ü–∞
‚Ä¢ –¶–≤–µ—Ç–Ω—ã–µ –∑–∞–ª–∏–≤–∫–∏ (–∫—Ä–æ–º–µ —à—Ç—Ä–∏—Ö–æ–≤–∫–∏)
‚Ä¢ –†–∞–∑–º—ã—Ç—ã–µ –ª–∏–Ω–∏–∏
‚Ä¢ –í–æ–¥—è–Ω—ã–µ –∑–Ω–∞–∫–∏"""


# ============================================================================
# –ü–†–û–ú–¢ –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê –§–û–¢–û–ì–†–ê–§–ò–ô –î–ï–§–ï–ö–¢–û–í
# ============================================================================

DEFECT_ANALYSIS_PROMPT = """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –û–¢–ö (–æ—Ç–¥–µ–ª —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è) –Ω–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–π –ø–ª–æ—â–∞–¥–∫–µ.
–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –∏ –¥–∞–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ.

üìã –°–¢–†–£–ö–¢–£–†–ê –ê–ù–ê–õ–ò–ó–ê:

1. **–ß–¢–û –í–ò–ñ–£** (—Ñ–∞–∫—Ç—ã):
   ‚Ä¢ –¢–∏–ø –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
   ‚Ä¢ –ú–∞—Ç–µ—Ä–∏–∞–ª
   ‚Ä¢ –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –¥–µ—Ñ–µ–∫—Ç—ã

2. **–ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–Ø –î–ï–§–ï–ö–¢–ê**:
   ‚Ä¢ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π / –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π / –ú–∞–ª–æ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π
   ‚Ä¢ –í–ª–∏—è–Ω–∏–µ –Ω–∞ –Ω–µ—Å—É—â—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
   ‚Ä¢ –í–ª–∏—è–Ω–∏–µ –Ω–∞ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é

3. **–ü–†–ò–ß–ò–ù–ê** (–≤–µ—Ä–æ—è—Ç–Ω–∞—è):
   ‚Ä¢ –ù–∞—Ä—É—à–µ–Ω–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
   ‚Ä¢ –ù–µ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
   ‚Ä¢ –≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π –∏–∑–Ω–æ—Å
   ‚Ä¢ –í–Ω–µ—à–Ω–∏–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è

4. **–ù–û–†–ú–ê–¢–ò–í**:
   ‚Ä¢ –°—Å—ã–ª–∫–∞ –Ω–∞ –°–ü/–ì–û–°–¢
   ‚Ä¢ –î–æ–ø—É—Å—Ç–∏–º—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
   ‚Ä¢ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

5. **–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò**:
   ‚Ä¢ –°—Ä–æ—á–Ω–æ—Å—Ç—å —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è
   ‚Ä¢ –ú–µ—Ç–æ–¥ —Ä–µ–º–æ–Ω—Ç–∞
   ‚Ä¢ –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
   ‚Ä¢ –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å

6. **–î–û–ö–£–ú–ï–ù–¢–ò–†–û–í–ê–ù–ò–ï**:
   ‚Ä¢ –ö–∞–∫–æ–π –∞–∫—Ç —Å–æ—Å—Ç–∞–≤–∏—Ç—å
   ‚Ä¢ –ß—Ç–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å
   ‚Ä¢ –§–æ—Ç–æ —Ñ–∏–∫—Å–∞—Ü–∏—è

‚ö†Ô∏è –í–ê–ñ–ù–û:
‚Ä¢ –ï—Å–ª–∏ –¥–µ—Ñ–µ–∫—Ç –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏ –æ–± –æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø–µ—Ä–≤—ã–º –¥–µ–ª–æ–º
‚Ä¢ –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ ‚Äî –ø–æ–ø—Ä–æ—Å–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–∞–∫—É—Ä—Å—ã
‚Ä¢ –ï—Å–ª–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ‚Äî —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ —á—Ç–æ –Ω—É–∂–Ω–æ

üì± –§–û–†–ú–ê–¢: –∫—Ä–∞—Ç–∫–∏–π, –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (35 —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Å—Ç—Ä–æ–∫–µ)"""


# ============================================================================
# –ü–†–û–ú–¢ –î–õ–Ø –ü–û–ò–°–ö–ê –í –ò–ù–¢–ï–†–ù–ï–¢–ï
# ============================================================================

WEB_SEARCH_PROMPT = """–ü—Ä–∏ –æ—Ç–≤–µ—Ç–µ –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å:
1. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π live_search –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
2. –ü—Ä–æ–≤–µ—Ä—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (minstroyrf.gov.ru, docs.cntd.ru, consultant.ru)
3. –£–∫–∞–∂–∏ –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
4. –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å –±–ª–æ–∫:

üåê **–ò—Å—Ç–æ—á–Ω–∏–∫–∏:**
‚Ä¢ [–ù–∞–∑–≤–∞–Ω–∏–µ] ‚Äî URL
‚Ä¢ [–ù–∞–∑–≤–∞–Ω–∏–µ] ‚Äî URL

–ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–µ–π ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏ –æ–± —ç—Ç–æ–º."""


# ============================================================================
# –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° FAQ
# ============================================================================

def check_faq_match(question: str, faq_database: dict) -> Optional[str]:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –æ—Ç–≤–µ—Ç –≤ FAQ –±–∞–∑–µ (–±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è AI)

    Returns:
        str: –û—Ç–≤–µ—Ç –∏–∑ FAQ –∏–ª–∏ None
    """
    question_lower = question.lower()

    # –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º –≤ FAQ
    for category, items in faq_database.items():
        for key, answer in items.items():
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
            keywords = key.replace("_", " ").split()
            matches = sum(1 for kw in keywords if kw in question_lower)
            if matches >= len(keywords) * 0.6:  # 60% —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                return answer

    return None


# ============================================================================
# –ö–û–ù–¢–ï–ö–°–¢–ù–´–ï –ü–û–î–°–ö–ê–ó–ö–ò
# ============================================================================

CONTEXT_HINTS = {
    "–±–µ—Ç–æ–Ω": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /calculators –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –±–µ—Ç–æ–Ω–∞",
    "–∞—Ä–º–∞—Ç—É—Ä–∞": "–†–∞—Å—á—ë—Ç –∞—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è: /calculators ‚Üí –ê—Ä–º–∞—Ç—É—Ä–∞",
    "–∫–∏—Ä–ø–∏—á": "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫–∏—Ä–ø–∏—á–∞: /calculators",
    "–¥–µ—Ñ–µ–∫—Ç": "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –¥–µ—Ñ–µ–∫—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞",
    "–∞–∫—Ç": "–®–∞–±–ª–æ–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: /templates",
    "–Ω–æ—Ä–º–∞—Ç–∏–≤": "–ù–æ—Ä–º–∞—Ç–∏–≤—ã 2025: /regulations",
    "–ø–æ–≥–æ–¥–∞": "–ü—Ä–æ–≥–Ω–æ–∑ –¥–ª—è —Å—Ç—Ä–æ–π–∫–∏: —É–∫–∞–∂–∏—Ç–µ –≥–æ—Ä–æ–¥",
}


def get_context_hint(question: str) -> Optional[str]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞"""
    question_lower = question.lower()

    for keyword, hint in CONTEXT_HINTS.items():
        if keyword in question_lower:
            return f"\n\nüí° *{hint}*"

    return None


# ============================================================================
# –ü–ê–†–ê–ú–ï–¢–†–´ –ú–û–î–ï–õ–ï–ô
# ============================================================================

MODEL_PARAMS = {
    AIModel.GROK_2: {
        "max_tokens": 2000,
        "temperature": 0.7,
        "timeout": 60,
    },
    AIModel.GROK_3: {
        "max_tokens": 4000,
        "temperature": 0.5,
        "timeout": 120,
    },
    AIModel.GEMINI_FLASH: {
        "max_tokens": 2000,
        "temperature": 0.4,
    },
    AIModel.DALLE_3: {
        "size": "1024x1024",
        "quality": "hd",
        "style": "natural",
    },
}


def get_model_params(model: AIModel) -> dict:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –º–æ–¥–µ–ª–∏"""
    return MODEL_PARAMS.get(model, MODEL_PARAMS[AIModel.GROK_2])


# ============================================================================
# –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø API (–¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞—Ç—Ä–∞—Ç)
# ============================================================================

class APIUsageTracker:
    """–¢—Ä–µ–∫–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞—Ç—Ä–∞—Ç"""

    def __init__(self):
        self.usage = {
            "grok_2": {"calls": 0, "tokens": 0},
            "grok_3": {"calls": 0, "tokens": 0},
            "gemini": {"calls": 0, "tokens": 0},
            "dalle": {"calls": 0, "images": 0},
            "faq_hits": 0,
            "calculator_hits": 0,
        }

    def log_api_call(self, model: AIModel, tokens: int = 0):
        """–õ–æ–≥–∏—Ä—É–µ—Ç –≤—ã–∑–æ–≤ API"""
        if model == AIModel.GROK_2:
            self.usage["grok_2"]["calls"] += 1
            self.usage["grok_2"]["tokens"] += tokens
        elif model == AIModel.GROK_3:
            self.usage["grok_3"]["calls"] += 1
            self.usage["grok_3"]["tokens"] += tokens
        elif model == AIModel.GEMINI_FLASH:
            self.usage["gemini"]["calls"] += 1
            self.usage["gemini"]["tokens"] += tokens
        elif model == AIModel.DALLE_3:
            self.usage["dalle"]["calls"] += 1
            self.usage["dalle"]["images"] += 1

        logger.info(f"üìä API: {model.value}, —Ç–æ–∫–µ–Ω—ã: {tokens}")

    def log_faq_hit(self):
        """–õ–æ–≥–∏—Ä—É–µ—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–µ –≤ FAQ (—ç–∫–æ–Ω–æ–º–∏—è)"""
        self.usage["faq_hits"] += 1
        logger.info("üí∞ FAQ hit ‚Äî AI –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω")

    def log_calculator_hit(self):
        """–õ–æ–≥–∏—Ä—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ (—ç–∫–æ–Ω–æ–º–∏—è)"""
        self.usage["calculator_hits"] += 1
        logger.info("üí∞ Calculator hit ‚Äî AI –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω")

    def get_stats(self) -> dict:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"""
        return self.usage

    def get_savings_report(self) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á—ë—Ç –æ–± —ç–∫–æ–Ω–æ–º–∏–∏"""
        saved_calls = self.usage["faq_hits"] + self.usage["calculator_hits"]
        total_calls = (
            self.usage["grok_2"]["calls"] +
            self.usage["grok_3"]["calls"] +
            self.usage["gemini"]["calls"] +
            saved_calls
        )

        if total_calls == 0:
            return "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"

        savings_percent = (saved_calls / total_calls) * 100

        return f"""üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ API:**
‚Ä¢ Grok 2: {self.usage['grok_2']['calls']} –≤—ã–∑–æ–≤–æ–≤
‚Ä¢ Grok 3: {self.usage['grok_3']['calls']} –≤—ã–∑–æ–≤–æ–≤
‚Ä¢ Gemini: {self.usage['gemini']['calls']} –≤—ã–∑–æ–≤–æ–≤
‚Ä¢ DALL-E: {self.usage['dalle']['calls']} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
‚Ä¢ FAQ (–±–µ–∑ AI): {self.usage['faq_hits']}
‚Ä¢ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ã: {self.usage['calculator_hits']}

üí∞ **–≠–∫–æ–Ω–æ–º–∏—è:** {savings_percent:.1f}% –∑–∞–ø—Ä–æ—Å–æ–≤ –±–µ–∑ AI"""


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä
api_tracker = APIUsageTracker()


# ============================================================================
# –≠–ö–°–ü–û–†–¢
# ============================================================================

__all__ = [
    'QueryType',
    'AIModel',
    'classify_query',
    'get_optimal_model',
    'get_model_params',
    'check_faq_match',
    'get_context_hint',
    'SYSTEM_PROMPT_OPTIMIZED',
    'BLUEPRINT_GENERATION_PROMPT',
    'DEFECT_ANALYSIS_PROMPT',
    'WEB_SEARCH_PROMPT',
    'api_tracker',
]
