# Интеграция Gemini AI для визуализации дефектов

## Обзор

В StroiNadzorAI добавлена интеграция с Gemini 1.5 Pro для создания детальных технических описаний визуализации строительных дефектов.

## Что было добавлено

### 1. Новый модуль `gemini_image_gen.py`

Модуль предоставляет класс `GeminiImageGenerator` с следующими возможностями:

- **Анализ фотографий дефектов** - создание технических описаний для визуализации на основе изображений
- **Генерация описаний по тексту** - создание описаний визуализации на основе текстового описания дефекта
- **Сравнение до/после** - анализ изменений для отчетов о ремонте
- **Визуализация нормативов** - создание описаний для диаграмм и схем
- **Аннотирование изображений** - рекомендации по размещению меток и выделению зон

### 2. Новая команда `/visualize`

Команда доступна в Telegram боте и имеет три режима работы:

#### Режим 1: Анализ фотографии
```
1. Отправьте фото дефекта с подписью /visualize
2. Получите детальное техническое описание для визуализации
```

#### Режим 2: Генерация по описанию
```
/visualize трещина в бетонной колонне шириной 2мм
```

#### Режим 3: Сравнение до/после
```
1. Отправьте фото с подписью /visualize compare
2. Получите описание изменений для отчетов
```

## Установка и настройка

### 1. Установка зависимостей

```bash
pip install google-generativeai==0.8.3
```

Или установите все зависимости:
```bash
pip install -r requirements.txt
```

### 2. Настройка API ключа

В файле `.env` уже добавлен ключ:
```
GEMINI_API_KEY=AIzaSyBth8MGnZvXNB1288eXWsUCj7bbbt0IRRM
```

### 3. Проверка работоспособности

Запустите тестовый скрипт:
```bash
python test_gemini.py
```

Ожидаемый вывод:
```
=== TEST GEMINI API INTEGRATION ===

[OK] GEMINI_API_KEY found (length: 39 chars)
     Key starts with: AIzaSyBth8MGnZv...

Initializing generator...
[OK] Gemini generator successfully initialized
     Type: GeminiImageGenerator
     Vision model: models/gemini-1.5-pro

=== ALL TESTS PASSED ===
```

## Использование в боте

### Примеры команд:

1. **Базовая визуализация:**
   ```
   /visualize
   ```
   Показывает справку по использованию

2. **Анализ по описанию:**
   ```
   /visualize трещина в несущей стене
   /visualize отслоение штукатурки 50x30см
   /visualize коррозия арматуры в колонне
   ```

3. **Анализ фотографии:**
   - Отправьте фото
   - Добавьте подпись: `/visualize`
   - Получите детальное описание

4. **Сравнение состояний:**
   - Отправьте фото
   - Добавьте подпись: `/visualize compare`
   - Получите описание изменений

## Что предоставляет визуализация

Технические описания включают:

1. **Внешний вид дефекта:**
   - Форма, размеры, цвет
   - Контекст и окружение
   - Масштаб и пропорции

2. **Рекомендации по визуализации:**
   - Цветовая схема для выделения зон
   - Размеры и координаты элементов
   - Типы маркеров (стрелки, круги, прямоугольники)

3. **Структурированные данные:**
   - Готовы для создания схем
   - Подходят для технической документации
   - Можно использовать с библиотеками визуализации

## Архитектура интеграции

### Файлы модуля:

- `gemini_image_gen.py` - основной модуль с классом GeminiImageGenerator
- `bot.py` - интеграция в Telegram бота
  - Строка 396-403: Импорт модуля
  - Строка 425-433: Инициализация генератора
  - Строка 1689-1779: Команда /visualize
  - Строка 1782-1804: Обработчик фотографий
  - Строка 2598-2600: Интеграция в handle_photo
  - Строка 5070-5073: Регистрация команды
  - Строка 4992: Добавление в меню команд

### Основные функции:

```python
# Инициализация
generator = get_gemini_generator()

# Анализ фотографии для визуализации
description = await generator.analyze_and_visualize_defect(
    image_bytes=photo_bytes,
    analysis_text="описание"
)

# Генерация описания по тексту
description = await generator.generate_defect_visualization(
    defect_description="трещина в стене",
    defect_type="общий",
    style="technical"
)

# Сравнение до/после
description = await generator.create_comparison_description(
    before_image=image_bytes,
    defect_info="информация"
)
```

## Особенности реализации

1. **Ленивая инициализация** - генератор создается только при первом использовании
2. **Graceful degradation** - если Gemini недоступен, бот продолжает работать
3. **Интеграция с существующим обработчиком фото** - проверка `/visualize` в подписи
4. **Поддержка текстовых и фото запросов** - универсальная команда

## Логирование

Все операции логируются:
- Успешная инициализация: `✅ Gemini Image Generator модуль загружен`
- Регистрация команды: `✅ Команда /visualize зарегистрирована (Gemini AI)`
- Ошибки инициализации: `⚠️ Модуль gemini_image_gen.py не найден`
- Ошибки при работе: `❌ Ошибка визуализации: {error}`

## Технические детали

### Используемая модель:
- **Gemini 1.5 Pro** (`gemini-1.5-pro`)
- Поддержка мультимодального ввода (текст + изображения)
- Высокое качество анализа технических изображений

### Лимиты и ограничения:
- API ключ предоставлен
- Ограничения Gemini API применяются согласно квоте
- Размер изображений: до 20 МБ

### Безопасность:
- API ключ хранится в `.env` файле
- Не включается в git (через .gitignore)
- Безопасная обработка ошибок

## Дальнейшие улучшения

Возможные расширения функциональности:

1. Добавление генерации изображений через Imagen 3
2. Интеграция с библиотеками визуализации (Matplotlib, Plotly)
3. Автоматическое создание аннотированных изображений
4. Экспорт в формате для CAD систем
5. Пакетная обработка нескольких дефектов

## Поддержка

При возникновении проблем:
1. Проверьте наличие `GEMINI_API_KEY` в `.env`
2. Убедитесь, что установлена правильная версия `google-generativeai==0.8.3`
3. Запустите `test_gemini.py` для диагностики
4. Проверьте логи бота в `bot.log`

## Статус интеграции

✅ Модуль создан и протестирован
✅ API ключ добавлен
✅ Зависимости установлены
✅ Команда зарегистрирована
✅ Интеграция в бота завершена
✅ Синтаксис проверен
✅ Тесты пройдены

**Система готова к использованию!**
