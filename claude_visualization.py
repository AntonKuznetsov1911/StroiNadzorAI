"""
–ú–æ–¥—É–ª—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ö–µ–º —Å –ø–æ–º–æ—â—å—é Claude API (Anthropic)
–ó–∞–º–µ–Ω—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å Gemini API
–í–µ—Ä—Å–∏—è: 1.0
"""

import os
import logging
import base64
from typing import Optional, Dict, Tuple
from anthropic import Anthropic

logger = logging.getLogger(__name__)


class ClaudeVisualizer:
    """–ö–ª–∞—Å—Å –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ö–µ–º —Å –ø–æ–º–æ—â—å—é Claude"""

    def __init__(self, api_key: str):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞

        Args:
            api_key: API –∫–ª—é—á –¥–ª—è Claude (Anthropic)
        """
        self.client = Anthropic(api_key=api_key)
        self.model = "claude-sonnet-4-20250514"  # –ü–æ—Å–ª–µ–¥–Ω—è—è –º–æ–¥–µ–ª—å —Å Vision
        logger.info(f"‚úÖ Claude Visualizer –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–º–æ–¥–µ–ª—å: {self.model})")

    async def visualize_defect(
        self,
        defect_description: str,
        defect_type: str = "–æ–±—â–∏–π",
        style: str = "technical"
    ) -> Optional[str]:
        """
        –°–æ–∑–¥–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–µ—Ñ–µ–∫—Ç–∞

        Args:
            defect_description: –û–ø–∏—Å–∞–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            defect_type: –¢–∏–ø –¥–µ—Ñ–µ–∫—Ç–∞ (—Ç—Ä–µ—â–∏–Ω–∞, –≤–ª–∞–≥–∞, –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ —Ç.–¥.)
            style: –°—Ç–∏–ª—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ (technical, realistic, schematic)

        Returns:
            –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ None
        """
        try:
            # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è Claude
            prompt = self._create_visualization_prompt(
                defect_description,
                defect_type,
                style
            )

            logger.info(f"üé® –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–µ—Ñ–µ–∫—Ç–∞: {defect_type}")

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ Claude
            response = self.client.messages.create(
                model=self.model,
                max_tokens=2000,
                temperature=0.7,
                messages=[{
                    "role": "user",
                    "content": prompt
                }]
            )

            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
            result = response.content[0].text

            logger.info("‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–æ")
            return result

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")
            return None

    async def analyze_and_visualize_photo(
        self,
        image_base64: str,
        image_media_type: str = "image/jpeg",
        analysis_request: str = "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ—Ñ–µ–∫—Ç –Ω–∞ —Ñ–æ—Ç–æ"
    ) -> Optional[str]:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –¥–µ—Ñ–µ–∫—Ç–∞ –∏ —Å–æ–∑–¥–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏

        Args:
            image_base64: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ base64
            image_media_type: –¢–∏–ø –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (image/jpeg, image/png, etc.)
            analysis_request: –ó–∞–ø—Ä–æ—Å –Ω–∞ –∞–Ω–∞–ª–∏–∑

        Returns:
            –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        """
        try:
            logger.info("üì∏ –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–µ—Ñ–µ–∫—Ç–∞ —Å –ø–æ–º–æ—â—å—é Claude Vision")

            # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ
            prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–π —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–µ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É –Ω–∞–¥–∑–æ—Ä—É.

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–µ—Ñ–µ–∫—Ç–∞ –∏ —Å–æ–∑–¥–∞–π –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏.

–ó–ê–î–ê–ß–ê:
{analysis_request}

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:

**1. –¢–ò–ü –ò –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–Ø –î–ï–§–ï–ö–¢–ê:**
- –ù–∞–∑–≤–∞–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞
- –¢–æ—á–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- –ì—Ä–∞–Ω–∏—Ü—ã —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è

**2. –í–ò–ó–£–ê–õ–¨–ù–´–ï –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:**
- –†–∞–∑–º–µ—Ä—ã (–¥–ª–∏–Ω–∞, —à–∏—Ä–∏–Ω–∞, –≥–ª—É–±–∏–Ω–∞)
- –§–æ—Ä–º–∞ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- –¶–≤–µ—Ç –∏ —Ç–µ–∫—Å—Ç—É—Ä–∞
- –•–∞—Ä–∞–∫—Ç–µ—Ä –∫—Ä–∞–µ–≤

**3. –°–¢–ï–ü–ï–ù–¨ –û–ü–ê–°–ù–û–°–¢–ò:**
- –û—Ü–µ–Ω–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π/–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π/–Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π)
- –í–ª–∏—è–Ω–∏–µ –Ω–∞ –Ω–µ—Å—É—â—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
- –†–∏—Å–∫–∏ —Ä–∞–∑–≤–∏—Ç–∏—è

**4. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ò:**
- –ö–ª—é—á–µ–≤—ã–µ –∑–æ–Ω—ã –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ü–≤–µ—Ç–∞ —Ä–∞–∑–º–µ—Ç–∫–∏
- –ß—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å –Ω–∞ —Å—Ö–µ–º–µ
- –ú–∞—Å—à—Ç–∞–± –∏ —É–≥–ª—ã –æ–±–∑–æ—Ä–∞

**5. –ù–û–†–ú–ê–¢–ò–í–ù–´–ï –°–°–´–õ–ö–ò:**
- –ü—Ä–∏–º–µ–Ω–∏–º—ã–µ –°–ü/–ì–û–°–¢/–°–ù–∏–ü
- –î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é

–ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —Ç–æ—á–µ–Ω!"""

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
            response = self.client.messages.create(
                model=self.model,
                max_tokens=3000,
                temperature=0.5,
                messages=[{
                    "role": "user",
                    "content": [
                        {
                            "type": "image",
                            "source": {
                                "type": "base64",
                                "media_type": image_media_type,
                                "data": image_base64
                            }
                        },
                        {
                            "type": "text",
                            "text": prompt
                        }
                    ]
                }]
            )

            result = response.content[0].text

            logger.info("‚úÖ –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω")
            return result

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏: {e}")
            return None

    async def generate_technical_scheme(
        self,
        scheme_description: str,
        scheme_type: str = "general"
    ) -> Optional[str]:
        """
        –°–æ–∑–¥–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π —Å—Ö–µ–º—ã

        Args:
            scheme_description: –û–ø–∏—Å–∞–Ω–∏–µ —Å—Ö–µ–º—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            scheme_type: –¢–∏–ø —Å—Ö–µ–º—ã (—É–∑–µ–ª, –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, –¥–µ—Ñ–µ–∫—Ç, etc.)

        Returns:
            –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ö–µ–º—ã
        """
        try:
            logger.info(f"üìê –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π —Å—Ö–µ–º—ã: {scheme_type}")

            prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–º—É —á–µ—Ä—á–µ–Ω–∏—é –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º —Å—Ö–µ–º–∞–º.

–ó–ê–î–ê–ß–ê: –°–æ–∑–¥–∞–π –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π —Å—Ö–µ–º—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–ó–ê–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
{scheme_description}

–¢–ò–ü –°–•–ï–ú–´: {scheme_type}

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:

**1. –ù–ê–ó–í–ê–ù–ò–ï –ò –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï –°–•–ï–ú–´:**
- –ü–æ–ª–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
- –î–ª—è —á–µ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

**2. –û–°–ù–û–í–ù–´–ï –≠–õ–ï–ú–ï–ù–¢–´:**
- –ü–µ—Ä–µ—á–µ–Ω—å –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –ò—Ö —Ä–∞–∑–º–µ—Ä—ã –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
- –ú–∞—Ç–µ—Ä–∏–∞–ª—ã

**3. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò:**
- –†–∞–∑–º–µ—Ä—ã –∏ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
- –£–≥–ª—ã –∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
- –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ —É–∑–ª—ã
- –ê—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)

**4. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ò:**
- –†–∞–∫—É—Ä—Å –∏ –≤–∏–¥ (–ø–ª–∞–Ω, —Ä–∞–∑—Ä–µ–∑, 3D)
- –ß—Ç–æ –≤—ã–¥–µ–ª–∏—Ç—å —Ü–≤–µ—Ç–æ–º
- –û–±–æ–∑–Ω–∞—á–µ–Ω–∏—è –∏ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞
- –ú–∞—Å—à—Ç–∞–±

**5. –ù–û–†–ú–ê–¢–ò–í–´:**
- –°–ü/–ì–û–°–¢/–°–ù–∏–ü
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

**6. –ü–û–®–ê–ì–û–í–û–ï –û–ü–ò–°–ê–ù–ò–ï –î–õ–Ø –ß–ï–†–¢–ï–ñ–ê:**
(–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∫–∞–∫ –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å —Å—Ö–µ–º—É)

–ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–µ–Ω –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —Ç–æ—á–µ–Ω!"""

            response = self.client.messages.create(
                model=self.model,
                max_tokens=2500,
                temperature=0.6,
                messages=[{
                    "role": "user",
                    "content": prompt
                }]
            )

            result = response.content[0].text

            logger.info("‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π —Å—Ö–µ–º—ã —Å–æ–∑–¥–∞–Ω–æ")
            return result

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Ö–µ–º—ã: {e}")
            return None

    def _create_visualization_prompt(
        self,
        description: str,
        defect_type: str,
        style: str
    ) -> str:
        """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–µ—Ñ–µ–∫—Ç–∞"""

        style_instructions = {
            "technical": "—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —Ç–æ—á–Ω—É—é, —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏ –∏ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è–º–∏",
            "realistic": "—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫—É—é –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é",
            "schematic": "—É–ø—Ä–æ—â–µ–Ω–Ω—É—é —Å—Ö–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é –¥–∏–∞–≥—Ä–∞–º–º—É"
        }

        style_text = style_instructions.get(style, style_instructions["technical"])

        return f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–π —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–µ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏.

–ó–ê–î–ê–ß–ê: –°–æ–∑–¥–∞–π –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–µ—Ñ–µ–∫—Ç–∞.

–û–ü–ò–°–ê–ù–ò–ï –î–ï–§–ï–ö–¢–ê:
{description}

–¢–ò–ü –î–ï–§–ï–ö–¢–ê: {defect_type}
–°–¢–ò–õ–¨ –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ò: {style_text}

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:

**1. –ê–ù–ê–õ–ò–ó –î–ï–§–ï–ö–¢–ê:**
- –¢–æ—á–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
- –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è
- –•–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏

**2. –î–ï–¢–ê–õ–ò –î–õ–Ø –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ò:**
- –†–∞–∑–º–µ—Ä—ã –∏ –º–∞—Å—à—Ç–∞–±
- –§–æ—Ä–º–∞ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- –¢–µ–∫—Å—Ç—É—Ä–∞ –∏ —Ü–≤–µ—Ç
- –•–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

**3. –¶–í–ï–¢–û–í–û–ï –ö–û–î–ò–†–û–í–ê–ù–ò–ï:**
- –û—Å–Ω–æ–≤–Ω—ã–µ –∑–æ–Ω—ã (—Ü–≤–µ—Ç–∞ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è)
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—á–∞—Å—Ç–∫–∏
- –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è

**4. –≠–õ–ï–ú–ï–ù–¢–´ –°–•–ï–ú–´:**
- –ß—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
- –†–∞–∑–º–µ—Ç–∫–∞ –∏ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è
- –°—Ç—Ä–µ–ª–∫–∏ –∏ —É–∫–∞–∑–∞—Ç–µ–ª–∏
- –†–∞–∑–º–µ—Ä–Ω—ã–µ –ª–∏–Ω–∏–∏

**5. –ù–û–†–ú–ê–¢–ò–í–´:**
- –°–ü/–ì–û–°–¢/–°–ù–∏–ü —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏
- –î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏

**6. –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –û–ü–ò–°–ê–ù–ò–ï –î–õ–Ø –°–û–ó–î–ê–ù–ò–Ø –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø:**
(–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∫–∞–∫ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –¥–µ—Ñ–µ–∫—Ç)

–ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –∏ –¥–µ—Ç–∞–ª–µ–Ω!"""


# ========================================
# –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
# ========================================

_claude_visualizer: Optional[ClaudeVisualizer] = None


def initialize_claude_visualizer() -> Optional[ClaudeVisualizer]:
    """
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Claude –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞

    Returns:
        –≠–∫–∑–µ–º–ø–ª—è—Ä ClaudeVisualizer –∏–ª–∏ None –µ—Å–ª–∏ API key –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    """
    global _claude_visualizer

    if _claude_visualizer is not None:
        return _claude_visualizer

    api_key = os.getenv("ANTHROPIC_API_KEY")

    if not api_key:
        logger.warning("‚ö†Ô∏è ANTHROPIC_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return None

    try:
        _claude_visualizer = ClaudeVisualizer(api_key)
        logger.info("‚úÖ Claude Visualizer —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        return _claude_visualizer
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Claude Visualizer: {e}")
        return None


def get_claude_visualizer() -> Optional[ClaudeVisualizer]:
    """
    –ü–æ–ª—É—á–∏—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä Claude –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ (–ª–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)

    Returns:
        –≠–∫–∑–µ–º–ø–ª—è—Ä ClaudeVisualizer –∏–ª–∏ None
    """
    global _claude_visualizer

    if _claude_visualizer is None:
        _claude_visualizer = initialize_claude_visualizer()

    return _claude_visualizer
