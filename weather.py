"""
–ú–æ–¥—É–ª—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –ø–æ–≥–æ–¥—ã —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å –ü–æ–≥–æ–¥–∞ API
"""

import os
import requests
import logging
from typing import Optional, Dict
from datetime import datetime

logger = logging.getLogger(__name__)

# API –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
YANDEX_WEATHER_API_KEY = os.getenv("YANDEX_WEATHER_API_KEY")

# –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫—Ä—É–ø–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ –†–æ—Å—Å–∏–∏ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫)
CITY_COORDINATES = {
    # –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–µ–≥–∏–æ–Ω
    "–º–æ—Å–∫–≤–∞": {"lat": 55.7558, "lon": 37.6173},
    "–º—Å–∫": {"lat": 55.7558, "lon": 37.6173},
    "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥": {"lat": 59.9311, "lon": 30.3609},
    "–ø–µ—Ç–µ—Ä–±—É—Ä–≥": {"lat": 59.9311, "lon": 30.3609},
    "—Å–ø–±": {"lat": 59.9311, "lon": 30.3609},
    "–≤–æ—Ä–æ–Ω–µ–∂": {"lat": 51.6720, "lon": 39.1843},
    "—Ç—É–ª–∞": {"lat": 54.1961, "lon": 37.6182},
    "—è—Ä–æ—Å–ª–∞–≤–ª—å": {"lat": 57.6261, "lon": 39.8845},
    "–∫–∞–ª—É–≥–∞": {"lat": 54.5293, "lon": 36.2754},
    "—Ç–≤–µ—Ä—å": {"lat": 56.8587, "lon": 35.9176},
    "—Ä—è–∑–∞–Ω—å": {"lat": 54.6269, "lon": 39.6916},

    # –Æ–≥
    "–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä": {"lat": 45.0355, "lon": 38.9753},
    "—Ä–æ—Å—Ç–æ–≤-–Ω–∞-–¥–æ–Ω—É": {"lat": 47.2357, "lon": 39.7015},
    "—Ä–æ—Å—Ç–æ–≤": {"lat": 47.2357, "lon": 39.7015},
    "—Å–æ—á–∏": {"lat": 43.5855, "lon": 39.7231},
    "–≤–æ–ª–≥–æ–≥—Ä–∞–¥": {"lat": 48.7080, "lon": 44.5133},
    "–∞—Å—Ç—Ä–∞—Ö–∞–Ω—å": {"lat": 46.3479, "lon": 48.0339},
    "—Å—Ç–∞–≤—Ä–æ–ø–æ–ª—å": {"lat": 45.0428, "lon": 41.9734},

    # –ü–æ–≤–æ–ª–∂—å–µ
    "–∫–∞–∑–∞–Ω—å": {"lat": 55.7887, "lon": 49.1221},
    "–Ω–∏–∂–Ω–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥": {"lat": 56.2965, "lon": 43.9361},
    "—Å–∞–º–∞—Ä–∞": {"lat": 53.1959, "lon": 50.1002},
    "—Å–∞—Ä–∞—Ç–æ–≤": {"lat": 51.5924, "lon": 46.0348},
    "—É—Ñ–∞": {"lat": 54.7388, "lon": 55.9721},
    "–ø–µ–Ω–∑–∞": {"lat": 53.2000, "lon": 45.0000},

    # –£—Ä–∞–ª
    "–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥": {"lat": 56.8389, "lon": 60.6057},
    "—á–µ–ª—è–±–∏–Ω—Å–∫": {"lat": 55.1644, "lon": 61.4368},
    "–ø–µ—Ä–º—å": {"lat": 58.0105, "lon": 56.2502},
    "—Ç—é–º–µ–Ω—å": {"lat": 57.1530, "lon": 65.5343},
    "–º–∞–≥–Ω–∏—Ç–æ–≥–æ—Ä—Å–∫": {"lat": 53.4071, "lon": 58.9792},

    # –°–∏–±–∏—Ä—å
    "–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫": {"lat": 55.0084, "lon": 82.9357},
    "–æ–º—Å–∫": {"lat": 54.9885, "lon": 73.3242},
    "–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫": {"lat": 56.0153, "lon": 92.8932},
    "—Ç–æ–º—Å–∫": {"lat": 56.4977, "lon": 84.9744},
    "–±–∞—Ä–Ω–∞—É–ª": {"lat": 53.3548, "lon": 83.7698},
    "–∏—Ä–∫—É—Ç—Å–∫": {"lat": 52.2869, "lon": 104.3050},
    "–∫–µ–º–µ—Ä–æ–≤–æ": {"lat": 55.3597, "lon": 86.0876},
    "–Ω–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫": {"lat": 53.7558, "lon": 87.1360},

    # –î–∞–ª—å–Ω–∏–π –í–æ—Å—Ç–æ–∫
    "–≤–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫": {"lat": 43.1056, "lon": 131.8735},
    "—Ö–∞–±–∞—Ä–æ–≤—Å–∫": {"lat": 48.4827, "lon": 135.0838},
    "—è–∫—É—Ç—Å–∫": {"lat": 62.0339, "lon": 129.7331},
}

def extract_city_from_query(query: str) -> Optional[str]:
    """
    –ò–∑–≤–ª–µ—á—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    Args:
        query: –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    Returns:
        –ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –∏–ª–∏ None
    """
    query_lower = query.lower()

    # –£–±–∏—Ä–∞–µ–º –æ–±—â–∏–µ —Å–ª–æ–≤–∞
    query_clean = query_lower.replace("–ø–æ–≥–æ–¥–∞", "").replace("–∫–∞–∫–∞—è", "").replace("–≤", "").replace("?", "").strip()

    # –ò—â–µ–º –≥–æ—Ä–æ–¥ –≤ —Å–ª–æ–≤–∞—Ä–µ
    for city in CITY_COORDINATES.keys():
        if city in query_clean:
            return city

    return None


def get_weather_yandex(lat: float, lon: float) -> Optional[Dict]:
    """
    –ü–æ–ª—É—á–∏—Ç—å –ø–æ–≥–æ–¥—É —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å –ü–æ–≥–æ–¥–∞ API

    Args:
        lat: –®–∏—Ä–æ—Ç–∞
        lon: –î–æ–ª–≥–æ—Ç–∞

    Returns:
        Dict —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –ø–æ–≥–æ–¥–µ –∏–ª–∏ None
    """
    if not YANDEX_WEATHER_API_KEY:
        logger.warning("‚ö†Ô∏è YANDEX_WEATHER_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        return None

    try:
        url = "https://api.weather.yandex.ru/v2/informers"
        headers = {
            "X-Yandex-API-Key": YANDEX_WEATHER_API_KEY
        }
        params = {
            "lat": lat,
            "lon": lon,
            "lang": "ru_RU"
        }

        logger.info(f"üå§Ô∏è –ó–∞–ø—Ä–æ—Å –ø–æ–≥–æ–¥—ã: lat={lat}, lon={lon}")

        response = requests.get(url, headers=headers, params=params, timeout=10)
        response.raise_for_status()

        data = response.json()

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        fact = data.get("fact", {})
        forecast = data.get("forecast", {})

        # –ü–µ—Ä–µ–≤–æ–¥ —É—Å–ª–æ–≤–∏–π –Ω–∞ —Ä—É—Å—Å–∫–∏–π
        condition_translation = {
            "clear": "—è—Å–Ω–æ",
            "partly-cloudy": "–º–∞–ª–æ–æ–±–ª–∞—á–Ω–æ",
            "cloudy": "–æ–±–ª–∞—á–Ω–æ",
            "overcast": "–ø–∞—Å–º—É—Ä–Ω–æ",
            "drizzle": "–º–æ—Ä–æ—Å—å",
            "light-rain": "–Ω–µ–±–æ–ª—å—à–æ–π –¥–æ–∂–¥—å",
            "rain": "–¥–æ–∂–¥—å",
            "moderate-rain": "—É–º–µ—Ä–µ–Ω–Ω—ã–π –¥–æ–∂–¥—å",
            "heavy-rain": "—Å–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å",
            "continuous-heavy-rain": "–ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω—ã–π —Å–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å",
            "showers": "–ª–∏–≤–µ–Ω—å",
            "wet-snow": "–¥–æ–∂–¥—å —Å–æ —Å–Ω–µ–≥–æ–º",
            "light-snow": "–Ω–µ–±–æ–ª—å—à–æ–π —Å–Ω–µ–≥",
            "snow": "—Å–Ω–µ–≥",
            "snow-showers": "—Å–Ω–µ–≥–æ–ø–∞–¥",
            "hail": "–≥—Ä–∞–¥",
            "thunderstorm": "–≥—Ä–æ–∑–∞",
            "thunderstorm-with-rain": "–¥–æ–∂–¥—å —Å –≥—Ä–æ–∑–æ–π",
            "thunderstorm-with-hail": "–≥—Ä–æ–∑–∞ —Å –≥—Ä–∞–¥–æ–º"
        }

        condition = fact.get("condition", "")
        condition_ru = condition_translation.get(condition, condition)

        # –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ç—Ä–∞
        wind_dir_translation = {
            "nw": "—Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥–Ω—ã–π",
            "n": "—Å–µ–≤–µ—Ä–Ω—ã–π",
            "ne": "—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ—á–Ω—ã–π",
            "e": "–≤–æ—Å—Ç–æ—á–Ω—ã–π",
            "se": "—é–≥–æ-–≤–æ—Å—Ç–æ—á–Ω—ã–π",
            "s": "—é–∂–Ω—ã–π",
            "sw": "—é–≥–æ-–∑–∞–ø–∞–¥–Ω—ã–π",
            "w": "–∑–∞–ø–∞–¥–Ω—ã–π",
            "c": "—à—Ç–∏–ª—å"
        }

        wind_dir = fact.get("wind_dir", "")
        wind_dir_ru = wind_dir_translation.get(wind_dir, wind_dir)

        weather_data = {
            "temp": fact.get("temp"),
            "feels_like": fact.get("feels_like"),
            "condition": condition_ru,
            "wind_speed": fact.get("wind_speed"),
            "wind_dir": wind_dir_ru,
            "pressure_mm": fact.get("pressure_mm"),
            "humidity": fact.get("humidity"),
            "daytime": fact.get("daytime"),
            "polar": fact.get("polar"),
            "season": fact.get("season"),
            "obs_time": fact.get("obs_time"),
            "forecast": forecast
        }

        logger.info(f"‚úÖ –ü–æ–≥–æ–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞: {weather_data['temp']}¬∞C, {condition_ru}")
        return weather_data

    except requests.RequestException as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –Ø–Ω–¥–µ–∫—Å –ü–æ–≥–æ–¥–∞ API: {e}")
        return None
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–≥–æ–¥—ã: {e}")
        return None


def format_weather_response(city: str, weather_data: Dict) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –æ –ø–æ–≥–æ–¥–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    Args:
        city: –ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
        weather_data: –î–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ

    Returns:
        –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
    """
    temp = weather_data["temp"]
    feels_like = weather_data["feels_like"]
    condition = weather_data["condition"]
    wind_speed = weather_data["wind_speed"]
    wind_dir = weather_data["wind_dir"]
    humidity = weather_data["humidity"]
    pressure_mm = weather_data["pressure_mm"]

    # –≠–º–æ–¥–∑–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Å–ª–æ–≤–∏–π
    condition_emoji = {
        "—è—Å–Ω–æ": "‚òÄÔ∏è",
        "–º–∞–ª–æ–æ–±–ª–∞—á–Ω–æ": "üå§Ô∏è",
        "–æ–±–ª–∞—á–Ω–æ": "‚õÖ",
        "–ø–∞—Å–º—É—Ä–Ω–æ": "‚òÅÔ∏è",
        "–¥–æ–∂–¥—å": "üåßÔ∏è",
        "—Å–Ω–µ–≥": "üå®Ô∏è",
        "–≥—Ä–æ–∑–∞": "‚õàÔ∏è",
        "–≥—Ä–∞–¥": "üå®Ô∏è"
    }

    emoji = "üå§Ô∏è"
    for key, em in condition_emoji.items():
        if key in condition:
            emoji = em
            break

    response = f"""{emoji} **–ü–æ–≥–æ–¥–∞ –≤ {city.title()}**

üå°Ô∏è **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:** {temp}¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫ {feels_like}¬∞C)
‚òÅÔ∏è **–£—Å–ª–æ–≤–∏—è:** {condition}
üí® **–í–µ—Ç–µ—Ä:** {wind_dir}, {wind_speed} –º/—Å
üíß **–í–ª–∞–∂–Ω–æ—Å—Ç—å:** {humidity}%
üéöÔ∏è **–î–∞–≤–ª–µ–Ω–∏–µ:** {pressure_mm} –º–º —Ä—Ç.—Å—Ç.

üí° **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç:**"""

    # –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Å–ª–æ–≤–∏–π
    construction_tips = []

    # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
    if temp < -15:
        construction_tips.append("üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –º–æ—Ä–æ–∑! –ë–µ—Ç–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç —ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–æ–≥—Ä–µ–≤–∞ –∏ –ø—Ä–æ—Ç–∏–≤–æ–º–æ—Ä–æ–∑–Ω—ã—Ö –¥–æ–±–∞–≤–æ–∫")
        construction_tips.append("‚ö†Ô∏è –†–∞–±–æ—Ç—ã –Ω–∞ –≤—ã—Å–æ—Ç–µ –±–æ–ª–µ–µ 5 –º –∑–∞–ø—Ä–µ—â–µ–Ω—ã –ø—Ä–∏ T < -15¬∞C")
    elif temp < -5:
        construction_tips.append("‚ùÑÔ∏è –ó–∏–º–Ω–∏–π —Ä–µ–∂–∏–º: –¥–æ–±–∞–≤–∫–∏ –≤ –±–µ—Ç–æ–Ω (–Ω–∏—Ç—Ä–∏—Ç –Ω–∞—Ç—Ä–∏—è 3-5%), —É–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π")
        construction_tips.append("‚ö†Ô∏è –ö–æ–Ω—Ç—Ä–æ–ª—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –±–µ—Ç–æ–Ω–∞ –∫–∞–∂–¥—ã–µ 4 —á–∞—Å–∞")
    elif temp < 5:
        construction_tips.append("üå°Ô∏è –û—Å–µ–Ω–Ω–∏–π —Ä–µ–∂–∏–º: –≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–º–µ—Ä–∑–∞–Ω–∏–µ –≥—Ä—É–Ω—Ç–∞, —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –æ—Å–∞–¥–∫–∞–º–∏")
    elif temp > 30:
        construction_tips.append("‚òÄÔ∏è –ñ–∞—Ä–∞! –ë–µ—Ç–æ–Ω –±—ã—Å—Ç—Ä–æ –≤—ã—Å—ã—Ö–∞–µ—Ç - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–≤–ª–∞–∂–Ω–µ–Ω–∏–µ –∏ —É–∫—Ä—ã—Ç–∏–µ")
        construction_tips.append("üíß –ü–∏—Ç—å–µ–≤–æ–π —Ä–µ–∂–∏–º –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω, –Ω–∞–≤–µ—Å—ã –¥–ª—è —Ä–∞–±–æ—á–∏—Ö")
    elif temp > 25:
        construction_tips.append("üå°Ô∏è –¢–µ–ø–ª–æ: —É–≤–ª–∞–∂–Ω—è–π—Ç–µ –±–µ—Ç–æ–Ω –ø–æ—Å–ª–µ —É–∫–ª–∞–¥–∫–∏, –∏–∑–±–µ–≥–∞–π—Ç–µ —Ä–∞–±–æ—Ç –≤ –ø–æ–ª–¥–µ–Ω—å")

    # –û—Å–∞–¥–∫–∏
    if "–¥–æ–∂–¥—å" in condition or "–ª–∏–≤–µ–Ω—å" in condition:
        construction_tips.append("üåßÔ∏è –î–æ–∂–¥—å! –£–∫—Ä–æ–π—Ç–µ –∞—Ä–º–∞—Ç—É—Ä—É –∏ –±–µ—Ç–æ–Ω, –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–≤–∞—Ä–æ—á–Ω—ã–µ —Ä–∞–±–æ—Ç—ã")
        construction_tips.append("‚õî –ó–µ–º–ª—è–Ω—ã–µ —Ä–∞–±–æ—Ç—ã –≤ –∫–æ—Ç–ª–æ–≤–∞–Ω–∞—Ö –ø—Ä–∏ –ª–∏–≤–Ω–µ –∑–∞–ø—Ä–µ—â–µ–Ω—ã")

    if "—Å–Ω–µ–≥" in condition:
        construction_tips.append("üå®Ô∏è –°–Ω–µ–≥: –æ—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–µ—Ä–µ–¥ —Ä–∞–±–æ—Ç–æ–π, –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ª–µ—Å–∞")

    if "–≥—Ä–æ–∑–∞" in condition:
        construction_tips.append("‚õàÔ∏è –ì–†–û–ó–ê! –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å —Ä–∞–±–æ—Ç—ã –Ω–∞ –≤—ã—Å–æ—Ç–µ –∏ —Å –º–µ—Ç–∞–ª–ª–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏")

    # –í–µ—Ç–µ—Ä
    if wind_speed > 15:
        construction_tips.append("üö´ –í–ù–ò–ú–ê–ù–ò–ï: –í–µ—Ç–µ—Ä > 15 –º/—Å - —Ä–∞–±–æ—Ç—ã –∫—Ä–∞–Ω–æ–º –ó–ê–ü–†–ï–©–ï–ù–´!")
        construction_tips.append("‚ö†Ô∏è –ó–∞–∫—Ä–µ–ø–∏—Ç—å –≤—Å–µ –ª–µ–≥–∫–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –æ–ø–∞–ª—É–±–∫—É, —É–∫—Ä—ã–≤–Ω–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª")
    elif wind_speed > 10:
        construction_tips.append("üí® –°–∏–ª—å–Ω—ã–π –≤–µ—Ç–µ—Ä: –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–±–æ—Ç—ã –Ω–∞ –≤—ã—Å–æ—Ç–µ, –∑–∞–∫—Ä–µ–ø–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã")

    # –í–ª–∞–∂–Ω–æ—Å—Ç—å
    if humidity > 90:
        construction_tips.append("üíß –í—ã—Å–æ–∫–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å: —Å–≤–∞—Ä–∫–∞ –º–µ—Ç–∞–ª–ª–∞ –∑–∞—Ç—Ä—É–¥–Ω–µ–Ω–∞, —à—Ç—É–∫–∞—Ç—É—Ä–∫–∞ —Å–æ—Ö–Ω–µ—Ç –¥–æ–ª—å—à–µ")

    # –§–æ—Ä–º–∏—Ä—É–µ–º –≤—ã–≤–æ–¥
    if construction_tips:
        response += "\n" + "\n".join(f"‚Ä¢ {tip}" for tip in construction_tips[:4])  # –ú–∞–∫—Å–∏–º—É–º 4 —Å–æ–≤–µ—Ç–∞

    response += "\n\nüìä –ò—Å—Ç–æ—á–Ω–∏–∫: –Ø–Ω–¥–µ–∫—Å.–ü–æ–≥–æ–¥–∞"

    return response


def get_weather(query: str) -> Optional[str]:
    """
    –ü–æ–ª—É—á–∏—Ç—å –ø–æ–≥–æ–¥—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    Args:
        query: –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞ –≤ –ú–æ—Å–∫–≤–µ?")

    Returns:
        –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –æ –ø–æ–≥–æ–¥–µ –∏–ª–∏ None
    """
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –≥–æ—Ä–æ–¥
    city = extract_city_from_query(query)

    if not city:
        return None

    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    coords = CITY_COORDINATES.get(city)

    if not coords:
        return None

    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–≥–æ–¥—É
    weather_data = get_weather_yandex(coords["lat"], coords["lon"])

    if not weather_data:
        return None

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    return format_weather_response(city, weather_data)


# –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å –≤–æ–ø—Ä–æ—Å–æ–º –æ –ø–æ–≥–æ–¥–µ
def is_weather_query(query: str) -> bool:
    """
    –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å –≤–æ–ø—Ä–æ—Å–æ–º –æ –ø–æ–≥–æ–¥–µ

    Args:
        query: –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    Returns:
        True –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–ø—Ä–æ—Å –æ –ø–æ–≥–æ–¥–µ, False –∏–Ω–∞—á–µ
    """
    query_lower = query.lower()
    weather_keywords = ["–ø–æ–≥–æ–¥–∞", "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞", "–≥—Ä–∞–¥—É—Å", "—Ç–µ–ø–ª–æ", "—Ö–æ–ª–æ–¥–Ω–æ", "–¥–æ–∂–¥—å", "—Å–Ω–µ–≥"]

    return any(keyword in query_lower for keyword in weather_keywords)
