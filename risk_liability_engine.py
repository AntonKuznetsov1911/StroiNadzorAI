"""
–°—Ç—Ä–æ–π–ù–∞–¥–∑–æ—ÄAI - Risk & Liability Engine
========================================
–î–≤–∏–∂–æ–∫ –æ—Ü–µ–Ω–∫–∏ —Ä–∏—Å–∫–æ–≤ –∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

–§—É–Ω–∫—Ü–∏–∏:
- –û—Ü–µ–Ω–∫–∞ —É—Ä–æ–≤–Ω—è —Ä–∏—Å–∫–∞ (LOW/MEDIUM/HIGH/CRITICAL)
- –ê–Ω–∞–ª–∏–∑ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ–± –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∏—Å–∫–æ–≤
"""

import re
import logging
from typing import Dict, List, Optional, Tuple
from dataclasses import dataclass
from enum import Enum

logger = logging.getLogger(__name__)


# ============================================================================
# –£–†–û–í–ù–ò –†–ò–°–ö–ê
# ============================================================================

class RiskLevel(Enum):
    """–£—Ä–æ–≤–Ω–∏ —Ä–∏—Å–∫–∞"""
    LOW = "low"           # –ù–∏–∑–∫–∏–π - –∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã
    MEDIUM = "medium"     # –°—Ä–µ–¥–Ω–∏–π - —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è
    HIGH = "high"         # –í—ã—Å–æ–∫–∏–π - —Å–µ—Ä—å—ë–∑–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è
    CRITICAL = "critical" # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π - —É–≥—Ä–æ–∑–∞ –∂–∏–∑–Ω–∏/–∞–≤–∞—Ä–∏–∏


class LiabilityType(Enum):
    """–¢–∏–ø—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏"""
    NONE = "none"               # –ù–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
    ADMINISTRATIVE = "admin"    # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è
    CIVIL = "civil"             # –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–æ-–ø—Ä–∞–≤–æ–≤–∞—è
    CRIMINAL = "criminal"       # –£–≥–æ–ª–æ–≤–Ω–∞—è
    DISCIPLINARY = "discipl"    # –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω–∞—è


# ============================================================================
# –ë–ê–ó–ê –†–ò–°–ö–û–í –ò –ü–û–°–õ–ï–î–°–¢–í–ò–ô
# ============================================================================

RISK_PATTERNS = {
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏ (—É–≥—Ä–æ–∑–∞ –∂–∏–∑–Ω–∏)
    "critical": {
        "keywords": [
            "–æ–±—Ä—É—à–µ–Ω–∏–µ", "–∞–≤–∞—Ä–∏—è", "—Ä–∞–∑—Ä—É—à–µ–Ω–∏–µ", "–≤–∑—Ä—ã–≤", "–ø–æ–∂–∞—Ä",
            "—Ç—Ä–∞–≤–º–∞", "—Å–º–µ—Ä—Ç—å", "–Ω–µ—Å—á–∞—Å—Ç–Ω—ã–π —Å–ª—É—á–∞–π", "—É–≥—Ä–æ–∑–∞ –∂–∏–∑–Ω–∏",
            "—ç–≤–∞–∫—É–∞—Ü–∏—è", "–ß–ü", "–ß–°", "–∞–≤–∞—Ä–∏–π–Ω—ã–π", "–æ–ø–∞—Å–Ω–æ—Å—Ç—å",
            "—ç–ª–µ–∫—Ç—Ä–æ—Ç—Ä–∞–≤–º–∞", "–ø–∞–¥–µ–Ω–∏–µ —Å –≤—ã—Å–æ—Ç—ã", "–æ–±–≤–∞–ª"
        ],
        "consequences": [
            "–£–≥–æ–ª–æ–≤–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –ø–æ —Å—Ç. 216, 217, 238, 293 –£–ö –†–§",
            "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞",
            "–†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –†–æ—Å—Ç–µ—Ö–Ω–∞–¥–∑–æ—Ä–∞/–°–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∫–æ–º–∏—Ç–µ—Ç–∞",
            "–õ–∏—à–µ–Ω–∏–µ —Å–≤–æ–±–æ–¥—ã –¥–æ 7 –ª–µ—Ç –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∂–µ—Ä—Ç–≤",
            "–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è —É—â–µ—Ä–±–∞ –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏–º"
        ],
        "articles": [
            "—Å—Ç. 216 –£–ö –†–§ (–Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –≤–µ–¥–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç)",
            "—Å—Ç. 217 –£–ö –†–§ (–Ω–∞—Ä—É—à–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –ø—Ä–æ–º–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –û–ü–û)",
            "—Å—Ç. 238 –£–ö –†–§ (–æ–∫–∞–∑–∞–Ω–∏–µ —É—Å–ª—É–≥, –Ω–µ –æ—Ç–≤–µ—á–∞—é—â–∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)",
            "—Å—Ç. 293 –£–ö –†–§ (—Ö–∞–ª–∞—Ç–Ω–æ—Å—Ç—å)"
        ]
    },

    # –í—ã—Å–æ–∫–∏–µ —Ä–∏—Å–∫–∏ (—Å–µ—Ä—å—ë–∑–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è)
    "high": {
        "keywords": [
            "–±–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞", "–±–µ–∑ —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã", "–±–µ–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è", "–±–µ–∑ –†–ù–°",
            "—Å–∞–º–æ–≤–æ–ª—å–Ω–∞—è –ø–æ—Å—Ç—Ä–æ–π–∫–∞", "–Ω–µ–∑–∞–∫–æ–Ω–Ω–æ–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ",
            "—Ñ–∞–ª—å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è", "–ø–æ–¥–¥–µ–ª–∫–∞", "—Å–∫—Ä—ã—Ç–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞",
            "–Ω–µ—Å—É—â–∞—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è", "–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–∞—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è",
            "–≥—Ä—É–±–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ", "—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–µ—Ñ–µ–∫—Ç"
        ],
        "consequences": [
            "–û—Ç–∫–∞–∑ –≤ –≤—ã–¥–∞—á–µ –ó–û–° (–∑–∞–∫–ª—é—á–µ–Ω–∏—è –æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏)",
            "–ü—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ –æ —Å–Ω–æ—Å–µ/–¥–µ–º–æ–Ω—Ç–∞–∂–µ",
            "–®—Ç—Ä–∞—Ñ –¥–æ 1 000 000 —Ä—É–±. (—é—Ä. –ª–∏—Ü–æ)",
            "–î–∏—Å–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ–ª–∂–Ω–æ—Å—Ç–Ω—ã—Ö –ª–∏—Ü",
            "–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –°–†–û",
            "–°—É–¥–µ–±–Ω—ã–µ —Å–ø–æ—Ä—ã —Å –∑–∞–∫–∞–∑—á–∏–∫–æ–º"
        ],
        "articles": [
            "—Å—Ç. 9.4 –ö–æ–ê–ü –†–§ (–Ω–∞—Ä—É—à–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π)",
            "—Å—Ç. 9.5 –ö–æ–ê–ü –†–§ (–Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞)",
            "—Å—Ç. 222 –ì–ö –†–§ (—Å–∞–º–æ–≤–æ–ª—å–Ω–∞—è –ø–æ—Å—Ç—Ä–æ–π–∫–∞)"
        ]
    },

    # –°—Ä–µ–¥–Ω–∏–µ —Ä–∏—Å–∫–∏ (–Ω–∞—Ä—É—à–µ–Ω–∏—è –Ω–æ—Ä–º)
    "medium": {
        "keywords": [
            "–Ω–∞—Ä—É—à–µ–Ω–∏–µ", "–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ", "–Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ", "–∑–∞–º–µ—á–∞–Ω–∏–µ",
            "–ø—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ", "–¥–µ—Ñ–µ–∫—Ç", "–±—Ä–∞–∫", "–ø–µ—Ä–µ–¥–µ–ª–∫–∞",
            "–±–µ–∑ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è", "–±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤", "–Ω–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ",
            "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ", "–∏—Å—Ç—ë–∫ —Å—Ä–æ–∫"
        ],
        "consequences": [
            "–ü—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Ö–Ω–∞–¥–∑–æ—Ä–∞ –æ–± —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–∏",
            "–ó–∞–¥–µ—Ä–∂–∫–∞ –≤–≤–æ–¥–∞ –≤ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é",
            "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ",
            "–®—Ç—Ä–∞—Ñ –¥–æ 300 000 —Ä—É–±.",
            "–°–Ω–∏–∂–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤"
        ],
        "articles": [
            "—Å—Ç. 9.4 –ö–æ–ê–ü –†–§ (–Ω–∞—Ä—É—à–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π)",
            "–ì—Ä–ö –†–§ —Å—Ç. 55 (–≤–≤–æ–¥ –≤ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é)"
        ]
    },

    # –ù–∏–∑–∫–∏–µ —Ä–∏—Å–∫–∏ (–Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è)
    "low": {
        "keywords": [
            "–∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–π", "–Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π", "–º–µ–ª–∫–∏–π",
            "–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ", "–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è", "–∂—É—Ä–Ω–∞–ª"
        ],
        "consequences": [
            "–ó–∞–º–µ—á–∞–Ω–∏–µ –≤ –∞–∫—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫–∏",
            "–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–ª–∞–Ω–æ–≤–æ–º –ø–æ—Ä—è–¥–∫–µ",
            "–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã"
        ],
        "articles": []
    }
}

# –®—Ç—Ä–∞—Ñ—ã –ø–æ –ö–æ–ê–ü –†–§
PENALTIES = {
    "9.4": {  # –ù–∞—Ä—É—à–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
        "physical": "5 000 - 10 000 —Ä—É–±.",
        "official": "20 000 - 30 000 —Ä—É–±.",
        "legal": "100 000 - 300 000 —Ä—É–±.",
        "repeat": "—à—Ç—Ä–∞—Ñ √ó 2, –¥–∏—Å–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ 3 –ª–µ—Ç"
    },
    "9.5": {  # –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
        "physical": "2 000 - 5 000 —Ä—É–±.",
        "official": "20 000 - 50 000 —Ä—É–±.",
        "legal": "500 000 - 1 000 000 —Ä—É–±.",
        "repeat": "–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–æ 90 —Å—É—Ç–æ–∫"
    },
    "9.5.1": {  # –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –±–µ–∑ –†–ù–°
        "official": "20 000 - 50 000 —Ä—É–±.",
        "legal": "500 000 - 1 000 000 —Ä—É–±. –∏–ª–∏ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ 90 —Å—É—Ç–æ–∫"
    }
}

# –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –ª–∏—Ü–∞
RESPONSIBLE_PARTIES = {
    "contractor": {
        "name": "–ü–æ–¥—Ä—è–¥—á–∏–∫ (–≥–µ–Ω–ø–æ–¥—Ä—è–¥—á–∏–∫)",
        "responsibility": [
            "–ö–∞—á–µ—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç",
            "–°–æ–±–ª—é–¥–µ–Ω–∏–µ –ü–î –∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤",
            "–û—Ö—Ä–∞–Ω–∞ —Ç—Ä—É–¥–∞ –Ω–∞ –ø–ª–æ—â–∞–¥–∫–µ",
            "–í–µ–¥–µ–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏"
        ]
    },
    "developer": {
        "name": "–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫ (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∑–∞–∫–∞–∑—á–∏–∫)",
        "responsibility": [
            "–ü–æ–ª—É—á–µ–Ω–∏–µ –†–ù–°",
            "–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è",
            "–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ–±—ä–µ–∫—Ç–∞ –ø—Ä–æ–µ–∫—Ç—É",
            "–ü–æ–ª—É—á–µ–Ω–∏–µ –ó–û–° –∏ –≤–≤–æ–¥ –≤ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é"
        ]
    },
    "designer": {
        "name": "–ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤—â–∏–∫",
        "responsibility": [
            "–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ü–î –Ω–æ—Ä–º–∞—Ç–∏–≤–∞–º",
            "–ê–≤—Ç–æ—Ä—Å–∫–∏–π –Ω–∞–¥–∑–æ—Ä",
            "–í–Ω–µ—Å–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ü–î"
        ]
    },
    "supervisor": {
        "name": "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å",
        "responsibility": [
            "–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç",
            "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ü–î",
            "–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ –∞–∫—Ç–æ–≤ —Å–∫—Ä—ã—Ç—ã—Ö —Ä–∞–±–æ—Ç"
        ]
    }
}


# ============================================================================
# –ú–û–î–ï–õ–ò –î–ê–ù–ù–´–•
# ============================================================================

@dataclass
class RiskAssessment:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ü–µ–Ω–∫–∏ —Ä–∏—Å–∫–∞"""
    level: RiskLevel
    score: float                    # 0-100
    keywords_found: List[str]
    consequences: List[str]
    legal_articles: List[str]
    liability_type: LiabilityType
    responsible_parties: List[str]
    recommendations: List[str]
    warnings: List[str]


# ============================================================================
# –î–í–ò–ñ–û–ö –û–¶–ï–ù–ö–ò –†–ò–°–ö–û–í
# ============================================================================

class RiskLiabilityEngine:
    """–î–≤–∏–∂–æ–∫ –æ—Ü–µ–Ω–∫–∏ —Ä–∏—Å–∫–æ–≤ –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏"""

    def __init__(self):
        self.risk_patterns = RISK_PATTERNS
        self.penalties = PENALTIES
        self.responsible_parties = RESPONSIBLE_PARTIES

    def assess_risk(self, text: str, context: Dict = None) -> RiskAssessment:
        """
        –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞ –ø–æ —Ç–µ–∫—Å—Ç—É –∑–∞–ø—Ä–æ—Å–∞/–æ—Ç–≤–µ—Ç–∞

        Args:
            text: –¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            context: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç

        Returns:
            RiskAssessment
        """
        text_lower = text.lower()
        context = context or {}

        # –ü–æ–¥—Å—á—ë—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –ø–æ —É—Ä–æ–≤–Ω—è–º
        matches = {
            "critical": [],
            "high": [],
            "medium": [],
            "low": []
        }

        for level, config in self.risk_patterns.items():
            for keyword in config["keywords"]:
                if keyword.lower() in text_lower:
                    matches[level].append(keyword)

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞
        if matches["critical"]:
            level = RiskLevel.CRITICAL
            level_key = "critical"
            score = 90 + min(len(matches["critical"]) * 2, 10)
            liability = LiabilityType.CRIMINAL
        elif matches["high"]:
            level = RiskLevel.HIGH
            level_key = "high"
            score = 70 + min(len(matches["high"]) * 3, 20)
            liability = LiabilityType.ADMINISTRATIVE
        elif matches["medium"]:
            level = RiskLevel.MEDIUM
            level_key = "medium"
            score = 40 + min(len(matches["medium"]) * 5, 30)
            liability = LiabilityType.CIVIL
        elif matches["low"]:
            level = RiskLevel.LOW
            level_key = "low"
            score = 10 + min(len(matches["low"]) * 5, 20)
            liability = LiabilityType.NONE
        else:
            level = RiskLevel.LOW
            level_key = "low"
            score = 5
            liability = LiabilityType.NONE

        # –°–æ–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –∏ —Å—Ç–∞—Ç—å–∏
        config = self.risk_patterns[level_key]
        consequences = config["consequences"]
        articles = config["articles"]

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö
        responsible = self._determine_responsible(text_lower, context)

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        recommendations = self._generate_recommendations(level, matches, context)

        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        warnings = self._generate_warnings(level, matches)

        # –í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
        all_keywords = []
        for kw_list in matches.values():
            all_keywords.extend(kw_list)

        return RiskAssessment(
            level=level,
            score=min(score, 100),
            keywords_found=all_keywords,
            consequences=consequences,
            legal_articles=articles,
            liability_type=liability,
            responsible_parties=responsible,
            recommendations=recommendations,
            warnings=warnings
        )

    def _determine_responsible(self, text: str, context: Dict) -> List[str]:
        """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ª–∏—Ü"""
        responsible = []

        # –ü–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º –≤ —Ç–µ–∫—Å—Ç–µ
        if any(w in text for w in ["–ø–æ–¥—Ä—è–¥—á–∏–∫", "–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å", "—Ä–∞–±–æ—Ç—ã", "–∫–∞—á–µ—Å—Ç–≤–æ"]):
            responsible.append("–ü–æ–¥—Ä—è–¥—á–∏–∫")

        if any(w in text for w in ["–∑–∞—Å—Ç—Ä–æ–π—â–∏–∫", "–∑–∞–∫–∞–∑—á–∏–∫", "—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ", "—Ä–Ω—Å"]):
            responsible.append("–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫")

        if any(w in text for w in ["–ø—Ä–æ–µ–∫—Ç", "–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤—â–∏–∫", "–ø–¥", "—á–µ—Ä—Ç—ë–∂"]):
            responsible.append("–ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤—â–∏–∫")

        if any(w in text for w in ["–Ω–∞–¥–∑–æ—Ä", "–∫–æ–Ω—Ç—Ä–æ–ª—å", "–ø—Ä–æ–≤–µ—Ä–∫–∞", "–∞–∫—Ç"]):
            responsible.append("–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å")

        # –ï—Å–ª–∏ –Ω–∏–∫–æ–≥–æ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏
        if not responsible:
            responsible.append("–¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ç–æ—á–Ω–µ–Ω–∏–µ")

        return responsible

    def _generate_recommendations(
        self,
        level: RiskLevel,
        matches: Dict,
        context: Dict
    ) -> List[str]:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π"""
        recommendations = []

        if level == RiskLevel.CRITICAL:
            recommendations.extend([
                "üö® –ù–ï–ú–ï–î–õ–ï–ù–ù–û –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–±–æ—Ç—ã",
                "üìû –£–≤–µ–¥–æ–º–∏—Ç—å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –∏ —Å–ª—É–∂–±—É –æ—Ö—Ä–∞–Ω—ã —Ç—Ä—É–¥–∞",
                "üìã –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é –∞–∫—Ç–æ–º",
                "üë∑ –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ - —ç–≤–∞–∫—É–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∞",
                "üì± –ü—Ä–∏ —Ç—Ä–∞–≤–º–∞—Ö - –≤—ã–∑–æ–≤ —Å–∫–æ—Ä–æ–π –ø–æ–º–æ—â–∏"
            ])

        elif level == RiskLevel.HIGH:
            recommendations.extend([
                "‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–±–æ—Ç—ã –¥–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Ä—É—à–µ–Ω–∏–π",
                "üìù –°–æ—Å—Ç–∞–≤–∏—Ç—å –∞–∫—Ç –æ –Ω–∞—Ä—É—à–µ–Ω–∏—è—Ö",
                "üìß –£–≤–µ–¥–æ–º–∏—Ç—å –∑–∞–∫–∞–∑—á–∏–∫–∞ –ø–∏—Å—å–º–µ–Ω–Ω–æ",
                "üë®‚Äçüíº –ü—Ä–æ–≤–µ—Å—Ç–∏ —Å–æ–≤–µ—â–∞–Ω–∏–µ —Å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ª–∏—Ü–∞–º–∏",
                "üìÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ä–æ–∫–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è"
            ])

        elif level == RiskLevel.MEDIUM:
            recommendations.extend([
                "üìã –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∏–µ –≤ –∂—É—Ä–Ω–∞–ª–µ",
                "üîß –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –≤ –ø–ª–∞–Ω–æ–≤–æ–º –ø–æ—Ä—è–¥–∫–µ",
                "üìä –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ",
                "üìù –í–Ω–µ—Å—Ç–∏ –≤ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç"
            ])

        else:
            recommendations.extend([
                "‚úèÔ∏è –û—Ç–º–µ—Ç–∏—Ç—å –≤ –∂—É—Ä–Ω–∞–ª–µ —Ä–∞–±–æ—Ç",
                "üîÑ –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏"
            ])

        return recommendations

    def _generate_warnings(self, level: RiskLevel, matches: Dict) -> List[str]:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π"""
        warnings = []

        if level == RiskLevel.CRITICAL:
            warnings.append("‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –†–ò–°–ö: –í–æ–∑–º–æ–∂–Ω–∞ —É–≥—Ä–æ–∑–∞ –∂–∏–∑–Ω–∏ –∏ –∑–¥–æ—Ä–æ–≤—å—é!")
            warnings.append("‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω–∞ —É–≥–æ–ª–æ–≤–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å!")

        elif level == RiskLevel.HIGH:
            warnings.append("‚ö†Ô∏è –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫: –°–µ—Ä—å—ë–∑–Ω—ã–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è!")
            warnings.append("‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã –∫—Ä—É–ø–Ω—ã–µ —à—Ç—Ä–∞—Ñ—ã –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞")

        elif level == RiskLevel.MEDIUM:
            warnings.append("‚ö†Ô∏è –°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫: –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ –∫ –Ω–∞—Ä—É—à–µ–Ω–∏—é")

        if "–±–µ–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è" in str(matches) or "–±–µ–∑ —Ä–Ω—Å" in str(matches).lower():
            warnings.append("‚ö†Ô∏è –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –±–µ–∑ –†–ù–° - —Å—Ç. 9.5 –ö–æ–ê–ü –†–§ (—à—Ç—Ä–∞—Ñ –¥–æ 1 –º–ª–Ω —Ä—É–±.)")

        if "—Å–∞–º–æ–≤–æ–ª—å–Ω–∞—è" in str(matches):
            warnings.append("‚ö†Ô∏è –°–∞–º–æ–≤–æ–ª—å–Ω–∞—è –ø–æ—Å—Ç—Ä–æ–π–∫–∞ - —Å—Ç. 222 –ì–ö –†–§ (—Å–Ω–æ—Å –∑–∞ —Å—á—ë—Ç –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞)")

        return warnings

    def get_penalty_info(self, article: str) -> Optional[Dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —à—Ç—Ä–∞—Ñ–∞—Ö"""
        return self.penalties.get(article)

    def format_assessment(self, assessment: RiskAssessment) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ –¥–ª—è Telegram"""
        lines = []

        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å —É—Ä–æ–≤–Ω–µ–º —Ä–∏—Å–∫–∞
        level_icons = {
            RiskLevel.LOW: "üü¢ –ù–ò–ó–ö–ò–ô",
            RiskLevel.MEDIUM: "üü° –°–†–ï–î–ù–ò–ô",
            RiskLevel.HIGH: "üü† –í–´–°–û–ö–ò–ô",
            RiskLevel.CRITICAL: "üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô"
        }

        lines.append(f"‚öñÔ∏è **–û–¶–ï–ù–ö–ê –†–ò–°–ö–ê**")
        lines.append(f"–£—Ä–æ–≤–µ–Ω—å: {level_icons[assessment.level]} ({assessment.score:.0f}/100)")
        lines.append("")

        # –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
        if assessment.keywords_found:
            lines.append("üîç **–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞:**")
            lines.append(f"_{', '.join(assessment.keywords_found[:5])}_")
            lines.append("")

        # –í–æ–∑–º–æ–∂–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è
        if assessment.consequences:
            lines.append("‚ö° **–í–æ–∑–º–æ–∂–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**")
            for c in assessment.consequences[:4]:
                lines.append(f"‚Ä¢ {c}")
            lines.append("")

        # –ü—Ä–∞–≤–æ–≤—ã–µ –Ω–æ—Ä–º—ã
        if assessment.legal_articles:
            lines.append("üìú **–ü—Ä–∞–≤–æ–≤—ã–µ –Ω–æ—Ä–º—ã:**")
            for a in assessment.legal_articles[:3]:
                lines.append(f"‚Ä¢ {a}")
            lines.append("")

        # –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ
        if assessment.responsible_parties:
            lines.append("üë§ **–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –ª–∏—Ü–∞:**")
            lines.append(f"_{', '.join(assessment.responsible_parties)}_")
            lines.append("")

        # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        if assessment.warnings:
            for w in assessment.warnings:
                lines.append(w)
            lines.append("")

        # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        if assessment.recommendations:
            lines.append("‚úÖ **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**")
            for r in assessment.recommendations[:5]:
                lines.append(r)

        return "\n".join(lines)


# ============================================================================
# –ì–õ–û–ë–ê–õ–¨–ù–´–ô –≠–ö–ó–ï–ú–ü–õ–Ø–†
# ============================================================================

_engine: Optional[RiskLiabilityEngine] = None


def get_risk_engine() -> RiskLiabilityEngine:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–≤–∏–∂–∫–∞"""
    global _engine
    if _engine is None:
        _engine = RiskLiabilityEngine()
    return _engine


# ============================================================================
# API
# ============================================================================

def assess_risk(text: str, context: Dict = None) -> RiskAssessment:
    """API –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Ä–∏—Å–∫–∞"""
    engine = get_risk_engine()
    return engine.assess_risk(text, context)


def get_risk_level(text: str) -> RiskLevel:
    """–ë—ã—Å—Ç—Ä–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —Ä–∏—Å–∫–∞"""
    assessment = assess_risk(text)
    return assessment.level


def is_critical_risk(text: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫"""
    return get_risk_level(text) == RiskLevel.CRITICAL


def is_high_risk(text: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫"""
    level = get_risk_level(text)
    return level in [RiskLevel.HIGH, RiskLevel.CRITICAL]


def format_risk_assessment(text: str) -> str:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ —Ä–∏—Å–∫–∞"""
    engine = get_risk_engine()
    assessment = engine.assess_risk(text)
    return engine.format_assessment(assessment)


def get_liability_warning(text: str) -> Optional[str]:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ–± –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏"""
    assessment = assess_risk(text)

    if assessment.liability_type == LiabilityType.CRIMINAL:
        return "‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï:** –í–æ–∑–º–æ–∂–Ω–∞ —É–≥–æ–ª–æ–≤–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å!"
    elif assessment.liability_type == LiabilityType.ADMINISTRATIVE:
        return "‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å (—à—Ç—Ä–∞—Ñ—ã –ø–æ –ö–æ–ê–ü –†–§)"
    elif assessment.liability_type == LiabilityType.CIVIL:
        return "‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω–∞ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–æ-–ø—Ä–∞–≤–æ–≤–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å"

    return None
