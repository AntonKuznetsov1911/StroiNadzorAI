<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°—Ç—Ä–æ–π–ù–∞–¥–∑–æ—ÄAI - –ì–æ–ª–æ—Å–æ–≤–æ–π –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1E3A8A 0%, #3B82F6 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: white;
        }

        .container {
            text-align: center;
            width: 100%;
            max-width: 500px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 40px;
        }

        .status {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .status-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .status-text {
            font-size: 16px;
            font-weight: 500;
        }

        .mic-button {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: 4px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            cursor: pointer;
            margin: 0 auto 30px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .mic-button:hover {
            transform: scale(1.05);
        }

        .mic-button:active {
            transform: scale(0.95);
        }

        .mic-button.listening {
            background: #EF4444;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 20px rgba(239, 68, 68, 0);
            }
        }

        .transcript-box {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            min-height: 120px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.2);
            text-align: left;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.user {
            background: rgba(59, 130, 246, 0.3);
            margin-left: 20px;
        }

        .message.bot {
            background: rgba(16, 185, 129, 0.3);
            margin-right: 20px;
        }

        .message-role {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 12px;
            opacity: 0.8;
        }

        .error {
            background: rgba(239, 68, 68, 0.3);
            border: 1px solid #EF4444;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hint {
            font-size: 13px;
            opacity: 0.8;
            margin-top: 20px;
        }

        .volume-indicator {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-top: 20px;
            height: 40px;
            align-items: flex-end;
        }

        .volume-bar {
            width: 6px;
            background: rgba(255,255,255,0.5);
            border-radius: 3px;
            transition: height 0.1s ease;
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <h1>üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</h1>
        <p class="subtitle">–°—Ç—Ä–æ–π–ù–∞–¥–∑–æ—ÄAI ‚Ä¢ Real-time –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç</p>

        <div class="status">
            <div class="status-icon" id="statusIcon">üîå</div>
            <div class="status-text" id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
        </div>

        <div class="mic-button" id="micButton" onclick="toggleListening()">
            üé§
        </div>

        <div class="volume-indicator" id="volumeIndicator" style="display: none;">
            <div class="volume-bar"></div>
            <div class="volume-bar"></div>
            <div class="volume-bar"></div>
            <div class="volume-bar"></div>
            <div class="volume-bar"></div>
        </div>

        <div class="transcript-box" id="transcriptBox">
            <div class="message bot">
                <div class="message-role">ü§ñ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</div>
                <div>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≥–æ—Ç–æ–≤ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–æ—Ä–º–∞—Ç–∏–≤–∞—Ö. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –≥–æ–ª–æ—Å–æ–º.</div>
            </div>
        </div>

        <p class="hint">üí° –ù–∞–ø—Ä–∏–º–µ—Ä: "–ö–∞–∫–∞—è –¥–æ–ø—É—Å—Ç–∏–º–∞—è —à–∏—Ä–∏–Ω–∞ —Ç—Ä–µ—â–∏–Ω –≤ –∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–µ?"</p>
    </div>

    <script>
        // WebSocket URL - –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ –ø—Ä–æ–∫—Å–∏ –Ω–∞ Railway
        const WS_URL = 'wss://websocket-proxy-production.up.railway.app/stream/user123';

        let ws = null;
        let audioContext = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isListening = false;
        let isConnected = false;
        let audioPlaybackQueue = [];
        let isPlaying = false;

        // –≠–ª–µ–º–µ–Ω—Ç—ã UI
        const micButton = document.getElementById('micButton');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const transcriptBox = document.getElementById('transcriptBox');
        const volumeIndicator = document.getElementById('volumeIndicator');

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', async () => {
            try {
                await connectWebSocket();
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
            }
        });

        async function connectWebSocket() {
            return new Promise((resolve, reject) => {
                updateStatus('üîå', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...');

                ws = new WebSocket(WS_URL);

                ws.onopen = () => {
                    console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                    isConnected = true;
                    updateStatus('‚úÖ', '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ! –ù–∞–∂–º–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω');
                    resolve();
                };

                ws.onmessage = async (event) => {
                    if (event.data instanceof Blob) {
                        // –ü–æ–ª—É—á–∏–ª–∏ –∞—É–¥–∏–æ –æ—Ç –±–æ—Ç–∞
                        await playAudio(event.data);
                    } else {
                        // JSON —Å–æ–æ–±—â–µ–Ω–∏–µ
                        const data = JSON.parse(event.data);
                        handleMessage(data);
                    }
                };

                ws.onerror = (error) => {
                    console.error('‚ùå WebSocket error:', error);
                    showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                    reject(error);
                };

                ws.onclose = () => {
                    console.log('üîå WebSocket –∑–∞–∫—Ä—ã—Ç');
                    isConnected = false;
                    updateStatus('üî¥', '–û—Ç–∫–ª—é—á–µ–Ω–æ');
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫
                    setTimeout(() => {
                        if (!isConnected) {
                            connectWebSocket();
                        }
                    }, 5000);
                };
            });
        }

        function handleMessage(data) {
            switch (data.type) {
                case 'ready':
                    console.log('‚úÖ –°–µ—Ä–≤–µ—Ä –≥–æ—Ç–æ–≤');
                    updateStatus('üé§', '–ì–æ—Ç–æ–≤! –ù–∞–∂–º–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω');
                    break;

                case 'transcript':
                    addMessage(data.text, data.role);
                    break;

                case 'turn_complete':
                    console.log('‚úÖ –û—Ç–≤–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω');
                    if (isListening) {
                        updateStatus('üé§', '–°–ª—É—à–∞—é...');
                    }
                    break;

                case 'error':
                    showError(data.message);
                    break;
            }
        }

        async function toggleListening() {
            if (!isConnected) {
                showError('–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü–æ–¥–æ–∂–¥–∏—Ç–µ...');
                return;
            }

            if (isListening) {
                stopListening();
            } else {
                await startListening();
            }
        }

        async function startListening() {
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });

                // –°–æ–∑–¥–∞—ë–º AudioContext
                audioContext = new AudioContext({ sampleRate: 16000 });
                const source = audioContext.createMediaStreamSource(stream);

                // ScriptProcessor –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ –≤ WebSocket
                const processor = audioContext.createScriptProcessor(4096, 1, 1);

                processor.onaudioprocess = (e) => {
                    if (!isListening || !ws || ws.readyState !== WebSocket.OPEN) return;

                    const inputData = e.inputBuffer.getChannelData(0);

                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Float32 –≤ Int16 PCM
                    const pcmData = new Int16Array(inputData.length);
                    for (let i = 0; i < inputData.length; i++) {
                        pcmData[i] = Math.max(-32768, Math.min(32767, inputData[i] * 32768));
                    }

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º binary –¥–∞–Ω–Ω—ã–µ
                    ws.send(pcmData.buffer);

                    // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏
                    updateVolumeIndicator(inputData);
                };

                source.connect(processor);
                processor.connect(audioContext.destination);

                isListening = true;
                micButton.classList.add('listening');
                updateStatus('üé§', '–°–ª—É—à–∞—é... –ì–æ–≤–æ—Ä–∏—Ç–µ!');
                volumeIndicator.style.display = 'flex';

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫–∏ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                window.currentStream = stream;
                window.currentProcessor = processor;

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
            }
        }

        function stopListening() {
            isListening = false;
            micButton.classList.remove('listening');
            updateStatus('‚úÖ', '–ì–æ—Ç–æ–≤! –ù–∞–∂–º–∏—Ç–µ —Å–Ω–æ–≤–∞');
            volumeIndicator.style.display = 'none';

            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º stream
            if (window.currentStream) {
                window.currentStream.getTracks().forEach(track => track.stop());
            }

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º AudioContext
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'stop' }));
            }
        }

        async function playAudio(audioBlob) {
            audioPlaybackQueue.push(audioBlob);
            if (!isPlaying) {
                playNextAudio();
            }
        }

        async function playNextAudio() {
            if (audioPlaybackQueue.length === 0) {
                isPlaying = false;
                return;
            }

            isPlaying = true;
            const audioBlob = audioPlaybackQueue.shift();

            try {
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);

                updateStatus('üîä', '–û—Ç–≤–µ—á–∞—é...');

                audio.onended = () => {
                    URL.revokeObjectURL(audioUrl);
                    playNextAudio(); // –ò–≥—Ä–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π chunk
                };

                await audio.play();

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', error);
                playNextAudio();
            }
        }

        function updateVolumeIndicator(audioData) {
            // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å –≥—Ä–æ–º–∫–æ—Å—Ç–∏
            let sum = 0;
            for (let i = 0; i < audioData.length; i++) {
                sum += Math.abs(audioData[i]);
            }
            const average = sum / audioData.length;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            const bars = volumeIndicator.querySelectorAll('.volume-bar');
            const activeCount = Math.floor(average * bars.length * 10);

            bars.forEach((bar, i) => {
                const height = i < activeCount ? `${(i + 1) * 8}px` : '4px';
                bar.style.height = height;
            });
        }

        function addMessage(text, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const roleSpan = document.createElement('div');
            roleSpan.className = 'message-role';
            roleSpan.textContent = role === 'user' ? 'üë§ –í—ã' : 'ü§ñ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç';

            const textDiv = document.createElement('div');
            textDiv.textContent = text;

            messageDiv.appendChild(roleSpan);
            messageDiv.appendChild(textDiv);
            transcriptBox.appendChild(messageDiv);

            // –°–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑
            transcriptBox.scrollTop = transcriptBox.scrollHeight;
        }

        function updateStatus(icon, text) {
            statusIcon.textContent = icon;
            statusText.textContent = text;
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = '‚ùå ' + message;
            transcriptBox.appendChild(errorDiv);
            transcriptBox.scrollTop = transcriptBox.scrollHeight;

            updateStatus('‚ùå', '–û—à–∏–±–∫–∞');
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            if (isListening) {
                stopListening();
            }
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>
