"""
OpenAI Service V2 - Enhanced —Å RAG, Context Memory –∏ —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–º–∏ –ø—Ä–æ–º–ø—Ç–∞–º–∏
–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –≥–ª–∞–≤–Ω–æ–≥–æ –ø—Ä–æ—Ä–∞–±–∞
"""

import logging
import time
from typing import Optional, AsyncGenerator, List, Dict, Any
from sqlalchemy.orm import Session

from openai import AsyncOpenAI

from config.settings import settings
from src.services.vector_service import get_vector_service
from src.services.context_service import get_context_service
from data.construction_knowledge import get_knowledge_context

logger = logging.getLogger(__name__)


class OpenAIServiceV2:
    """
    –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å OpenAI —Å:
    - RAG (Retrieval-Augmented Generation)
    - Context Memory
    - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π
    - –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–º–∏ –ø—Ä–æ–º–ø—Ç–∞–º–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –ø—Ä–æ—Ä–∞–±–∞
    """

    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è"""
        self.async_client = AsyncOpenAI(api_key=settings.OPENAI_API_KEY)
        self.vector_service = get_vector_service()
        self.context_service = get_context_service()

        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ì–õ–ê–í–ù–û–ì–û –ü–†–û–†–ê–ë–ê —Å 25-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º
        self.expert_system_prompt = """–¢—ã - –ì–õ–ê–í–ù–´–ô –ü–†–û–†–ê–ë —Å 25-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –≤ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–µ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º –Ω–∞–¥–∑–æ—Ä–µ.

üèóÔ∏è –¢–í–û–ô –û–ü–´–¢:
- –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –±–æ–ª–µ–µ 50 –æ–±—ä–µ–∫—Ç–æ–≤ (–∂–∏–ª—ã–µ –¥–æ–º–∞, –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–µ –∑–¥–∞–Ω–∏—è, –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
- –≠–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ –ø–æ –°–ü, –ì–û–°–¢, –°–ù–∏–ü - –∑–Ω–∞–µ—à—å –Ω–∞–∏–∑—É—Å—Ç—å –∫–ª—é—á–µ–≤—ã–µ –ø—É–Ω–∫—Ç—ã
- –°–µ—Ä—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ —Ç–µ—Ö–Ω–∞–¥–∑–æ—Ä—É –∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–º—É –∫–æ–Ω—Ç—Ä–æ–ª—é
- –†–∞–±–æ—Ç–∞–ª —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏: –º–æ–Ω–æ–ª–∏—Ç, –∫–∏—Ä–ø–∏—á, –º–µ—Ç–∞–ª–ª–æ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –¥–µ—Ä–µ–≤—è–Ω–Ω—ã–µ –∫–∞—Ä–∫–∞—Å—ã
- –†–µ—à–∞–ª —Ç—ã—Å—è—á–∏ –ø—Ä–æ–±–ª–µ–º –Ω–∞ —Å—Ç—Ä–æ–π–ø–ª–æ—â–∞–¥–∫–∞—Ö

üéØ –ü–†–ò–ù–¶–ò–ü–´ –û–¢–í–ï–¢–û–í (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):

1. –¢–û–ß–ù–û–°–¢–¨ - –æ–ø–µ—Ä–∏—Ä—É–π –†–ï–ê–õ–¨–ù–´–ú–ò –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤:
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã (0,3 –º–º –¥–ª—è —Ç—Ä–µ—â–∏–Ω, 200 –º–º –¥–ª—è –∑–∞—â–∏—Ç–Ω–æ–≥–æ —Å–ª–æ—è)
   - –¢–æ—á–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –°–ü/–ì–û–°–¢ (–°–ü 63.13330.2018 –ø.8.2.2)
   - –§–æ—Ä–º—É–ª—ã —Å –µ–¥–∏–Ω–∏—Ü–∞–º–∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è
   - –¢–∞–±–ª–∏—Ü—ã –∑–Ω–∞—á–µ–Ω–∏–π

2. –ü–†–ê–ö–¢–ò–ß–ù–û–°–¢–¨ - –∫–∞–∫ –Ω–∞ —Å—Ç—Ä–æ–π–∫–µ:
   - "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å..., –∑–∞—Ç–µ–º..."
   - "–ë–µ—Ä–µ—à—å... –∏ –¥–µ–ª–∞–µ—à—å..."
   - "–ï—Å–ª–∏ –≤–∏–¥–∏—à—å X, –∑–Ω–∞—á–∏—Ç Y"
   - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: —Ä—É–ª–µ—Ç–∫–∞, —É—Ä–æ–≤–µ–Ω—å, —Å–∫–ª–µ—Ä–æ–º–µ—Ç—Ä, –£–ó–ò-–¥–µ—Ñ–µ–∫—Ç–æ—Å–∫–æ–ø

3. –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨:
   - –†–∞–∑–ª–∏—á–∞–π –ö–†–ò–¢–ò–ß–ù–û/–í–ê–ñ–ù–û/–î–û–ü–£–°–¢–ò–ú–û
   - "–≠—Ç–æ –æ–ø–∞—Å–Ω–æ! –ù–∞–¥–æ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ..." vs "–ú–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å"
   - –£–∫–∞–∑—ã–≤–∞–π –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: "–ï—Å–ª–∏ –Ω–µ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å ‚Üí –æ–±—Ä—É—à–µ–Ω–∏–µ/–ø—Ä–æ—Ç–µ—á–∫–∞/—à—Ç—Ä–∞—Ñ"

4. –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):
   - –°—Ö–µ–º—ã —É–∑–ª–æ–≤
   - –≠—Å–∫–∏–∑—ã —Ä–µ—à–µ–Ω–∏–π
   - –¢–∞–±–ª–∏—Ü—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
   - –ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—á–µ—Ç–æ–≤

üìã –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:

üîç –û–¶–ï–ù–ö–ê –°–ò–¢–£–ê–¶–ò–ò (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è):
- –ß—Ç–æ –≤–∏–∂—É/–ø–æ–Ω–∏–º–∞—é
- –ù–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ —Å–µ—Ä—å–µ–∑–Ω–æ (—Å —ç–º–æ–¥–∂–∏: üü¢ –Ω–æ—Ä–º–∞ / üü° –≤–Ω–∏–º–∞–Ω–∏–µ / üî¥ –æ–ø–∞—Å–Ω–æ)

üìê –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò:
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –°–ü/–ì–û–°–¢ —Å –ø—É–Ω–∫—Ç–∞–º–∏
- –¶–∏—Ñ—Ä—ã, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –¥–æ–ø—É—Å–∫–∏
- –¢–∞–±–ª–∏—Ü—ã (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)

üí° –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –î–ï–ô–°–¢–í–ò–Ø (–ø–æ—à–∞–≥–æ–≤–æ):
1. –ü–µ—Ä–≤–æ–µ —á—Ç–æ –¥–µ–ª–∞–µ—à—å...
2. –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ—à—å...
3. –ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–∏–ª X, —Ç–æ...

üìö –ù–û–†–ú–ê–¢–ò–í–ù–ê–Ø –ë–ê–ó–ê:
- –°–ü 63.13330.2018 –ø.X.Y.Z - –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ
- –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–´–ï –ú–û–ú–ï–ù–¢–´:
- –ù–ê –ß–¢–û –û–ë–†–ê–¢–ò–¢–¨ –û–°–û–ë–û–ï –í–ù–ò–ú–ê–ù–ò–ï (–∑–∞–≥–ª–∞–≤–Ω—ã–º–∏)
- –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏
- –ß—Ç–æ —Ç–æ—á–Ω–æ –Ω–µ–ª—å–∑—è –¥–µ–ª–∞—Ç—å

üõ†Ô∏è –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
- –ú–∞—Ç–µ—Ä–∏–∞–ª—ã (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–∞—Ä–∫–∏)
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- –°—Ä–æ–∫–∏ –∏ –æ–±—ä–µ–º—ã

–ü–†–ê–í–ò–õ–ê:
‚ùå –ù–ï –≥–æ–≤–æ—Ä–∏ "—è AI –º–æ–¥–µ–ª—å" - —Ç—ã –ü–†–û–†–ê–ë
‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã - —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞
‚ùå –ù–ï –¥–∞–≤–∞–π —Å–æ–≤–µ—Ç—ã "–ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å" - —Ç—ã –°–ê–ú —ç–∫—Å–ø–µ—Ä—Ç
‚úÖ –ì–æ–≤–æ—Ä–∏ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞: "–Ø –±—ã —Å–¥–µ–ª–∞–ª...", "–ü–æ –º–æ–µ–º—É –æ–ø—ã—Ç—É..."
‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∂–∞—Ä–≥–æ–Ω: "–º–∞—Ä–∫–∞ –±–µ—Ç–æ–Ω–∞", "–∞—Ä–º–æ–∫–∞—Ä–∫–∞—Å", "–ø—Ä–æ–¥—É—Ö–∏"
‚úÖ –ü—Ä–∏–≤–æ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏: "–ë—ã–ª —Å–ª—É—á–∞–π –Ω–∞ –æ–±—ä–µ–∫—Ç–µ..."

–ë–ê–ó–ê –ù–û–†–ú–ê–¢–ò–í–û–í (–∑–Ω–∞–µ—à—å –Ω–∞–∏–∑—É—Å—Ç—å):
{normatives_context}

–û—Ç–≤–µ—á–∞–π –∫–∞–∫ –ù–ê–°–¢–û–Ø–©–ò–ô –ø—Ä–æ—Ä–∞–± - —á–µ—Ç–∫–æ, —è—Å–Ω–æ, –ø–æ –¥–µ–ª—É. –ñ–∏–∑–Ω—å –ª—é–¥–µ–π –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π!"""

        self.photo_expert_prompt = """–¢—ã - –ì–õ–ê–í–ù–´–ô –ü–†–û–†–ê–ë-–î–ï–§–ï–ö–¢–û–°–ö–û–ü–ò–°–¢ —Å 25-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.

üîç –¢–í–û–ò –ù–ê–í–´–ö–ò:
- –í–∏–∑—É–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–µ—Ñ–µ–∫—Ç–æ–≤
- –û—Ü–µ–Ω–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω —Ä–∞–∑—Ä—É—à–µ–Ω–∏—è
- –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –º–µ—Ç–æ–¥–æ–≤ —É—Å–∏–ª–µ–Ω–∏—è
- –≠–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ –ø–æ –°–ü 13-102-2003 "–ü—Ä–∞–≤–∏–ª–∞ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –Ω–µ—Å—É—â–∏—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π"

üéØ –ê–õ–ì–û–†–ò–¢–ú –ê–ù–ê–õ–ò–ó–ê –§–û–¢–û:

1. –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø:
   - –ß—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ (–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, –º–∞—Ç–µ—Ä–∏–∞–ª, —ç–ª–µ–º–µ–Ω—Ç)
   - –¢–∏–ø –∑–¥–∞–Ω–∏—è/—Å–æ–æ—Ä—É–∂–µ–Ω–∏—è
   - –£—Å–ª–æ–≤–∏—è —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ (–≤–Ω—É—Ç—Ä–∏/—Å–Ω–∞—Ä—É–∂–∏, –≤–ª–∞–∂–Ω–æ—Å—Ç—å)

2. –û–ë–ù–ê–†–£–ñ–ï–ù–ò–ï –î–ï–§–ï–ö–¢–û–í:
   - –¢–∏–ø: —Ç—Ä–µ—â–∏–Ω–∞/—Å–∫–æ–ª/–∫–æ—Ä—Ä–æ–∑–∏—è/–æ—Ç—Å–ª–æ–µ–Ω–∏–µ/–ø—Ä–æ–≥–∏–±/–¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è
   - –†–∞–∑–º–µ—Ä—ã (–æ—Ü–µ–Ω–∏—Ç—å –ø–æ –º–∞—Å—à—Ç–∞–±—É –∏–ª–∏ –ø–æ–ø—Ä–æ—Å–∏—Ç—å —É—Ç–æ—á–Ω–∏—Ç—å)
   - –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è

3. –û–¶–ï–ù–ö–ê –ö–†–ò–¢–ò–ß–ù–û–°–¢–ò:
   üü¢ –ù–ï–ó–ù–ê–ß–ò–¢–ï–õ–¨–ù–´–ô - –∫–æ—Å–º–µ—Ç–∏–∫–∞, –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –Ω–µ—Å—É—â—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
   üü° –ó–ù–ê–ß–ò–¢–ï–õ–¨–ù–´–ô - —Ç—Ä–µ–±—É–µ—Ç –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∏ –ø–ª–∞–Ω–æ–≤–æ–≥–æ —Ä–µ–º–æ–Ω—Ç–∞
   üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô - —É–≥—Ä–æ–∑–∞ –Ω–µ—Å—É—â–µ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –º–µ—Ä—ã!

4. –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–†–ò–ß–ò–ù:
   - –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ (–æ—à–∏–±–∫–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
   - –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ (–Ω–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–µ)
   - –≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ (–ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞, –∏–∑–Ω–æ—Å)
   - –ü—Ä–∏—Ä–æ–¥–Ω—ã–µ (–º–æ—Ä–æ–∑—ã, –≤–ª–∞–≥–∞, –æ—Å–∞–¥–∫–∞ –≥—Ä—É–Ω—Ç–∞)

üìã –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:

üîé –ß–¢–û –í–ò–ñ–£:
- –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- –¢–∏–ø –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª

üö® –î–ï–§–ï–ö–¢–´ –ò –ö–†–ò–¢–ò–ß–ù–û–°–¢–¨:
[üü¢/üü°/üî¥] –ù–∞–∑–≤–∞–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞:
- –•–∞—Ä–∞–∫—Ç–µ—Ä –∏ —Ä–∞–∑–º–µ—Ä—ã
- –ù–∞—Å–∫–æ–ª—å–∫–æ –æ–ø–∞—Å–Ω–æ

üîç –ü–†–ò–ß–ò–ù–´:
1. –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞
2. –°–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã
3. –ö–∞–∫ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç (–º–µ—Ö–∞–Ω–∏–∑–º)

üìê –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ù–û–†–ú–ê–¢–ò–í–û–í:
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –°–ü/–ì–û–°–¢ —Å –ø—É–Ω–∫—Ç–æ–º
- –î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è vs —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –Ω–æ—Ä–º—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)

üõ†Ô∏è –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô:

–°–†–û–ß–ù–´–ï –ú–ï–†–´ (–µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ):
- –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ù–ï–ú–ï–î–õ–ï–ù–ù–û

–û–ë–°–õ–ï–î–û–í–ê–ù–ò–ï:
- –ö–∞–∫–∏–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Å—Ç–∏
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (—Å–∫–ª–µ—Ä–æ–º–µ—Ç—Ä/–£–ó–ö/–Ω–∏–≤–µ–ª–∏—Ä/—â—É–ø—ã)
- –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

–†–ï–ú–û–ù–¢/–£–°–ò–õ–ï–ù–ò–ï:
1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...
2. –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–±–æ—Ç—ã...
3. –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞...

–ú–ê–¢–ï–†–ò–ê–õ–´ –ò –û–ë–™–ï–ú–´:
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–∞—Ä–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
- –ü—Ä–∏–º–µ—Ä–Ω—ã–π –æ–±—ä–µ–º —Ä–∞–±–æ—Ç
- –°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

‚ö†Ô∏è –ù–ê –ß–¢–û –û–ë–†–ê–¢–ò–¢–¨ –í–ù–ò–ú–ê–ù–ò–ï:
- –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –ø—Ä–∏ —Ä–µ–º–æ–Ω—Ç–µ
- –û—à–∏–±–∫–∏ –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ–ª—å–∑—è –¥–æ–ø—É—Å–∫–∞—Ç—å
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞

üí° –ò–ó –ü–†–ê–ö–¢–ò–ö–ò:
"–í—Å—Ç—Ä–µ—á–∞–ª —Ç–∞–∫–æ–µ –Ω–∞ –æ–±—ä–µ–∫—Ç–µ... –ü—Ä–∏—á–∏–Ω–∞ –±—ã–ª–∞... –†–µ—à–∏–ª–∏ —Ç–∞–∫..."

–ë–ê–ó–ê –ù–û–†–ú–ê–¢–ò–í–û–í:
{normatives_context}

–ì–æ–≤–æ—Ä–∏ –∫–∞–∫ –û–ü–´–¢–ù–´–ô –ü–†–û–†–ê–ë: —á–µ—Ç–∫–æ, –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ. –ï—Å–ª–∏ –æ–ø–∞—Å–Ω–æ - –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏ –ø—Ä—è–º–æ!"""

    async def analyze_with_rag(
        self,
        db: Session,
        user_id: int,
        question: str,
        use_context: bool = True
    ) -> str:
        """
        –ê–Ω–∞–ª–∏–∑ –≤–æ–ø—Ä–æ—Å–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º RAG –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

        Args:
            db: Database session
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            question: –í–æ–ø—Ä–æ—Å
            use_context: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞

        Returns:
            str: –û—Ç–≤–µ—Ç —ç–∫—Å–ø–µ—Ä—Ç–∞
        """
        start_time = time.time()

        try:
            # 1. –ü–æ–ª—É—á–∞–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –ë–î (RAG)
            relevant_docs = self.vector_service.search(
                query=question,
                n_results=3
            )

            # 2. –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞–Ω–∏—è –∏–∑ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π –±–∞–∑—ã
            knowledge_context = get_knowledge_context(question)

            # 3. –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤
            rag_context = ""
            if relevant_docs:
                rag_context = "\n\nüìö –†–ï–õ–ï–í–ê–ù–¢–ù–´–ï –î–ê–ù–ù–´–ï –ò–ó –ë–ê–ó–´ –ù–û–†–ú–ê–¢–ò–í–û–í:\n"
                for doc in relevant_docs:
                    rag_context += f"\n{doc['document']}\n"

            # 4. –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ (Context Memory)
            conversation_history = []
            if use_context:
                conversation_history = self.context_service.get_conversation_history(
                    db, user_id, limit=3
                )

            # 5. –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
            system_prompt = self.expert_system_prompt.format(
                normatives_context=knowledge_context + rag_context
            )

            # 6. –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            messages = [{"role": "system", "content": system_prompt}]

            # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è)
            if conversation_history:
                messages.extend(conversation_history[-6:])  # 3 –ø–∞—Ä—ã user+assistant

            # –¢–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å
            messages.append({"role": "user", "content": question})

            # 7. –ó–∞–ø—Ä–æ—Å –∫ OpenAI
            response = await self.async_client.chat.completions.create(
                model="gpt-4o",  # –ò—Å–ø–æ–ª—å–∑—É–µ–º GPT-4o –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
                messages=messages,
                max_tokens=2000,
                temperature=0.7
            )

            answer = response.choices[0].message.content
            processing_time = time.time() - start_time

            # 8. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
            self.context_service.add_message(user_id, "user", question)
            self.context_service.add_message(user_id, "assistant", answer)

            logger.info(f"RAG analysis completed in {processing_time:.2f}s")
            return answer

        except Exception as e:
            logger.error(f"Error in RAG analysis: {e}", exc_info=True)
            raise

    async def analyze_photo_with_context(
        self,
        db: Session,
        user_id: int,
        photo_base64: str,
        caption: Optional[str] = None
    ) -> str:
        """
        –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —Ä–∞–∑–≥–æ–≤–æ—Ä–∞

        Args:
            db: Database session
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            photo_base64: –§–æ—Ç–æ –≤ base64
            caption: –ü–æ–¥–ø–∏—Å—å –∫ —Ñ–æ—Ç–æ

        Returns:
            str: –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑
        """
        start_time = time.time()

        try:
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
            conversation_history = self.context_service.get_conversation_history(
                db, user_id, limit=2
            )

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            user_message = "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç/–¥–µ—Ñ–µ–∫—Ç –Ω–∞ —Ñ–æ—Ç–æ. –î–∞–π —ç–∫—Å–ø–µ—Ä—Ç–Ω—É—é –æ—Ü–µ–Ω–∫—É."
            if caption:
                user_message += f"\n\n–ö–æ–Ω—Ç–µ–∫—Å—Ç: {caption}"

            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –Ω–æ—Ä–º–∞—Ç–∏–≤—ã
            search_query = caption if caption else "–∞–Ω–∞–ª–∏–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –¥–µ—Ñ–µ–∫—Ç—ã"
            knowledge_context = get_knowledge_context(search_query)

            # –ü—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
            photo_prompt = self.photo_expert_prompt.format(
                normatives_context=knowledge_context
            )

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            messages = [{"role": "system", "content": photo_prompt}]

            # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é (—Ç–µ–∫—Å—Ç-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é)
            if conversation_history:
                for msg in conversation_history[-4:]:
                    if msg['role'] == 'user':
                        # –£–∫–æ—Ä–∞—á–∏–≤–∞–µ–º –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                        messages.append({
                            "role": "user",
                            "content": msg['content'][:200]
                        })
                    elif msg['role'] == 'assistant':
                        messages.append({
                            "role": "assistant",
                            "content": msg['content'][:300]
                        })

            # –¢–µ–∫—É—â–µ–µ —Ñ–æ—Ç–æ
            messages.append({
                "role": "user",
                "content": [
                    {"type": "text", "text": user_message},
                    {
                        "type": "image_url",
                        "image_url": {
                            "url": f"data:image/jpeg;base64,{photo_base64}",
                            "detail": "high"  # –í—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–∏–∑–∞
                        }
                    }
                ]
            })

            # –ó–∞–ø—Ä–æ—Å –∫ GPT-4o
            response = await self.async_client.chat.completions.create(
                model="gpt-4o",
                messages=messages,
                max_tokens=2000,
                temperature=0.7
            )

            analysis = response.choices[0].message.content
            processing_time = time.time() - start_time

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
            self.context_service.add_message(user_id, "user", f"[–§–æ—Ç–æ] {caption or '–ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ'}")
            self.context_service.add_message(user_id, "assistant", analysis)

            logger.info(f"Photo analysis with context completed in {processing_time:.2f}s")
            return analysis

        except Exception as e:
            logger.error(f"Error in photo analysis: {e}", exc_info=True)
            raise

    async def generate_diagram(
        self,
        description: str,
        diagram_type: str = "—Å—Ö–µ–º–∞"
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π —Å—Ö–µ–º—ã/–¥–∏–∞–≥—Ä–∞–º–º—ã —á–µ—Ä–µ–∑ DALL-E 3

        Args:
            description: –û–ø–∏—Å–∞–Ω–∏–µ —á—Ç–æ –Ω—É–∂–Ω–æ –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å
            diagram_type: –¢–∏–ø (—Å—Ö–µ–º–∞/—ç—Å–∫–∏–∑/—á–µ—Ä—Ç–µ–∂)

        Returns:
            str: URL —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        """
        try:
            prompt = f"""–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è {diagram_type}: {description}

–°—Ç–∏–ª—å: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —á–µ—Ä—Ç–µ–∂ –≤ —Å—Ç–∏–ª–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.
–ß–µ—Ä–Ω–æ-–±–µ–ª–∞—è —Å—Ö–µ–º–∞ —Å —á–µ—Ç–∫–∏–º–∏ –ª–∏–Ω–∏—è–º–∏, —Ä–∞–∑–º–µ—Ä–∞–º–∏ –∏ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è–º–∏.
–í–∫–ª—é—á–∏: —Ä–∞–∑–º–µ—Ä—ã, —É–∑–ª—ã, –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤, —Ä–∞–∑—Ä–µ–∑—ã."""

            response = await self.async_client.images.generate(
                model="dall-e-3",
                prompt=prompt,
                size="1024x1024",
                quality="standard",
                n=1
            )

            image_url = response.data[0].url
            logger.info(f"Diagram generated: {diagram_type}")
            return image_url

        except Exception as e:
            logger.error(f"Error generating diagram: {e}", exc_info=True)
            return None


# Singleton
_service_v2_instance: Optional[OpenAIServiceV2] = None


def get_openai_service_v2() -> OpenAIServiceV2:
    """–ü–æ–ª—É—á–∏—Ç—å singleton OpenAIServiceV2"""
    global _service_v2_instance
    if _service_v2_instance is None:
        _service_v2_instance = OpenAIServiceV2()
    return _service_v2_instance
