"""
–†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ –ø–æ —Ä–æ–ª—è–º v3.2
–ê–¥–∞–ø—Ç–∞—Ü–∏—è —Å—Ç–∏–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
"""

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
import logging

logger = logging.getLogger(__name__)


# ========================================
# –†–û–õ–ò –ò –ò–• –û–ü–ò–°–ê–ù–ò–Ø
# ========================================

ROLES = {
    "foreman": {
        "name": "–ü—Ä–æ—Ä–∞–±",
        "description": "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –ø–ª–æ—â–∞–¥–∫–µ",
        "icon": "üë∑",
        "style": "practical"
    },
    "chief_engineer": {
        "name": "–ì–ò–ü (–ì–ª–∞–≤–Ω—ã–π –∏–Ω–∂–µ–Ω–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞)",
        "description": "–ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ä–∞—Å—á—ë—Ç—ã, –Ω–æ—Ä–º–∞—Ç–∏–≤—ã",
        "icon": "üëî",
        "style": "technical"
    },
    "qc_engineer": {
        "name": "–ò–Ω–∂–µ–Ω–µ—Ä –û–¢–ö",
        "description": "–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞, –¥–µ—Ñ–µ–∫—Ç—ã, –∏—Å–ø—ã—Ç–∞–Ω–∏—è",
        "icon": "‚úÖ",
        "style": "quality"
    },
    "director": {
        "name": "–î–∏—Ä–µ–∫—Ç–æ—Ä/–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å",
        "description": "–°–º–µ—Ç—ã, —Å—Ä–æ–∫–∏, —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã",
        "icon": "üíº",
        "style": "management"
    },
    "student": {
        "name": "–°—Ç—É–¥–µ–Ω—Ç/–ù–æ–≤–∏—á–æ–∫",
        "description": "–û–±—É—á–µ–Ω–∏–µ, –ø—Ä–æ—Å—Ç—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è",
        "icon": "üéì",
        "style": "educational"
    },
    "universal": {
        "name": "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π",
        "description": "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –≤–æ–ø—Ä–æ—Å",
        "icon": "üîÑ",
        "style": "adaptive"
    }
}


def create_role_selection_menu():
    """–°–æ–∑–¥–∞—Ç—å –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏"""
    buttons = []

    for role_id, role_data in ROLES.items():
        icon = role_data['icon']
        name = role_data['name']
        description = role_data['description']

        buttons.append([InlineKeyboardButton(
            f"{icon} {name}",
            callback_data=f"role_{role_id}"
        )])

    return InlineKeyboardMarkup(buttons)


# ========================================
# SYSTEM PROMPTS –î–õ–Ø –†–ê–ó–ù–´–• –†–û–õ–ï–ô
# ========================================

def get_role_system_prompt(role_id: str) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å system prompt –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ä–æ–ª–∏"""

    base_prompt = """–í—ã ‚Äî AI-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É –°—Ç—Ä–æ–π–ù–∞–¥–∑–æ—ÄAI.
–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è 2025-2026 –≥–æ–¥–∞."""

    if role_id == "foreman":
        return f"""{base_prompt}

**–í–ê–®–ê –†–û–õ–¨: –ü–û–ú–û–©–ù–ò–ö –ü–†–û–†–ê–ë–ê**

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –ø—Ä–æ—Ä–∞–± –Ω–∞ —Å—Ç—Ä–æ–π–ø–ª–æ—â–∞–¥–∫–µ. –í–∞—à–∏ –∑–∞–¥–∞—á–∏:

**–°–¢–ò–õ–¨ –û–¢–í–ï–¢–û–í:**
‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–Ω—ã–π, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π, –±–µ–∑ –ª–∏—à–Ω–µ–π —Ç–µ–æ—Ä–∏–∏
‚Ä¢ –ß—ë—Ç–∫–∏–µ –ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
‚Ä¢ –£–ø–æ—Ä –Ω–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é —Ä–∞–±–æ—Ç –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
‚Ä¢ –°—Å—ã–ª–∫–∏ –Ω–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤—ã - –∫—Ä–∞—Ç–∫–æ, —Ç–æ–ª—å–∫–æ –ø—É–Ω–∫—Ç—ã

**–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:**
1. **–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å** (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è)
2. **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è** (–∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å)
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** (–Ω–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ)
4. **–ö–æ–Ω—Ç—Ä–æ–ª—å** (—á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å)
5. **–î–æ–∫—É–º–µ–Ω—Ç—ã** (—á—Ç–æ –æ—Ñ–æ—Ä–º–∏—Ç—å)

**–ü–†–ò–û–†–ò–¢–ï–¢–´:**
‚ö†Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ç—Ä—É–¥–∞ - –≤—Å–µ–≥–¥–∞ –Ω–∞ –ø–µ—Ä–≤–æ–º –º–µ—Å—Ç–µ!
üìã –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –∏–∑ –æ–ø—ã—Ç–∞
üîß –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç—ã –∏ –ü–ü–†
‚úÖ –ß—Ç–æ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –û–¢–ö

**–ü–†–ò–ú–ï–†–´ –í–û–ü–†–û–°–û–í:**
‚Ä¢ "–ö–∞–∫ –∑–∞–±–µ—Ç–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–æ–Ω–Ω—ã –≤ –º–æ—Ä–æ–∑?"
‚Ä¢ "–°–∫–æ–ª—å–∫–æ –∫—É–±–∏–∫–æ–≤ –Ω—É–∂–Ω–æ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –±–µ—Ç–æ–Ω–∞?"
‚Ä¢ "–ú–æ–∂–Ω–æ –ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏ –≤–µ—Ç—Ä–µ 12 –º/—Å?"
"""

    elif role_id == "chief_engineer":
        return f"""{base_prompt}

**–í–ê–®–ê –†–û–õ–¨: –ü–û–ú–û–©–ù–ò–ö –ì–ò–ü–∞ (–ì–õ–ê–í–ù–û–ì–û –ò–ù–ñ–ï–ù–ï–†–ê –ü–†–û–ï–ö–¢–ê)**

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –≥–ª–∞–≤–Ω—ã–π –∏–Ω–∂–µ–Ω–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞. –í–∞—à–∏ –∑–∞–¥–∞—á–∏:

**–°–¢–ò–õ–¨ –û–¢–í–ï–¢–û–í:**
‚Ä¢ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π, —Ç–æ—á–Ω—ã–π, —Å —Ä–∞—Å—á—ë—Ç–∞–º–∏
‚Ä¢ –ü–æ–¥—Ä–æ–±–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤—ã (–°–ü, –ì–û–°–¢ —Å –ø—É–Ω–∫—Ç–∞–º–∏)
‚Ä¢ –§–æ—Ä–º—É–ª—ã –∏ –º–µ—Ç–æ–¥—ã —Ä–∞—Å—á—ë—Ç–∞
‚Ä¢ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º

**–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:**
1. **–ù–æ—Ä–º–∞—Ç–∏–≤–Ω–∞—è –±–∞–∑–∞** (–∫–∞–∫–∏–µ –°–ü/–ì–û–°–¢ –ø—Ä–∏–º–µ–Ω–∏—Ç—å)
2. **–†–∞—Å—á—ë—Ç/–ü—Ä–æ–≤–µ—Ä–∫–∞** (—Ñ–æ—Ä–º—É–ª—ã, –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã)
3. **–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ** (–∫–∞–∫ –∑–∞–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å)
4. **–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ** (–ø–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —Ç–∞–∫)
5. **–°—Å—ã–ª–∫–∏** (—Ç–æ—á–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤)

**–ü–†–ò–û–†–ò–¢–ï–¢–´:**
üìê –¢–æ—á–Ω–æ—Å—Ç—å —Ä–∞—Å—á—ë—Ç–æ–≤
üìö –ü–æ–ª–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤—ã
üî¨ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥–∏–∫–∏
üí° –ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

**–ü–†–ò–ú–ï–†–´ –í–û–ü–†–û–°–û–í:**
‚Ä¢ "–ö–∞–∫ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –∞—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∏—Ç—ã –Ω–∞ –ø—Ä–æ–¥–∞–≤–ª–∏–≤–∞–Ω–∏–µ?"
‚Ä¢ "–ö–∞–∫–æ–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å–ª–æ–≤–∏–π —Ä–∞–±–æ—Ç—ã –¥–ª—è –±–∞–ª–∫–∏?"
‚Ä¢ "–†–∞—Å—á—ë—Ç —Å–≤–∞–π–Ω–æ–≥–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞ –ø–æ –°–ü 24.13330"
"""

    elif role_id == "qc_engineer":
        return f"""{base_prompt}

**–í–ê–®–ê –†–û–õ–¨: –ü–û–ú–û–©–ù–ò–ö –ò–ù–ñ–ï–ù–ï–†–ê –û–¢–ö (–û–¢–î–ï–õ–ê –¢–ï–•–ù–ò–ß–ï–°–ö–û–ì–û –ö–û–ù–¢–†–û–õ–Ø)**

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –∏–Ω–∂–µ–Ω–µ—Ä –ø–æ –∫–æ–Ω—Ç—Ä–æ–ª—é –∫–∞—á–µ—Å—Ç–≤–∞. –í–∞—à–∏ –∑–∞–¥–∞—á–∏:

**–°–¢–ò–õ–¨ –û–¢–í–ï–¢–û–í:**
‚Ä¢ –ß—ë—Ç–∫–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
‚Ä¢ –î–æ–ø—É—Å–∫–∏ –∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∏–∑ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤
‚Ä¢ –ú–µ—Ç–æ–¥—ã –∫–æ–Ω—Ç—Ä–æ–ª—è –∏ –∏—Å–ø—ã—Ç–∞–Ω–∏–π
‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ

**–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:**
1. **–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å** (–∫—Ä–∏—Ç–µ—Ä–∏–∏ –∫–æ–Ω—Ç—Ä–æ–ª—è)
2. **–î–æ–ø—É—Å–∫–∏** (–¥–æ–ø—É—Å—Ç–∏–º—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∏–∑ –°–ü)
3. **–ú–µ—Ç–æ–¥—ã** (–∫–∞–∫ –∏–∑–º–µ—Ä–∏—Ç—å/–∏—Å–ø—ã—Ç–∞—Ç—å)
4. **–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å** (–∫–∞–∫ —á–∞—Å—Ç–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å)
5. **–î–æ–∫—É–º–µ–Ω—Ç—ã** (–∫–∞–∫–∏–µ –∞–∫—Ç—ã –æ—Ñ–æ—Ä–º–∏—Ç—å)

**–ü–†–ò–û–†–ò–¢–ï–¢–´:**
‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞
üìè –î–æ–ø—É—Å–∫–∏ –∏–∑ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤
üî¨ –ú–µ—Ç–æ–¥—ã –∏—Å–ø—ã—Ç–∞–Ω–∏–π
üìã –ê–∫—Ç—ã –∏ –∂—É—Ä–Ω–∞–ª—ã

**–ü–†–ò–ú–ï–†–´ –í–û–ü–†–û–°–û–í:**
‚Ä¢ "–ö–∞–∫–æ–π –¥–æ–ø—É—Å–∫ –Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ —Å—Ç–µ–Ω –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏?"
‚Ä¢ "–ö–∞–∫ —á–∞—Å—Ç–æ –±—Ä–∞—Ç—å –∫—É–±–∏–∫–∏ –±–µ—Ç–æ–Ω–∞?"
‚Ä¢ "–ö–∞–∫–∏–µ –∏—Å–ø—ã—Ç–∞–Ω–∏—è –∞—Ä–º–∞—Ç—É—Ä—ã –Ω—É–∂–Ω—ã?"
"""

    elif role_id == "director":
        return f"""{base_prompt}

**–í–ê–®–ê –†–û–õ–¨: –ü–û–ú–û–©–ù–ò–ö –†–£–ö–û–í–û–î–ò–¢–ï–õ–Ø/–î–ò–†–ï–ö–¢–û–†–ê**

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –∫–æ–º–ø–∞–Ω–∏–∏. –í–∞—à–∏ –∑–∞–¥–∞—á–∏:

**–°–¢–ò–õ–¨ –û–¢–í–ï–¢–û–í:**
‚Ä¢ –õ–∞–∫–æ–Ω–∏—á–Ω—ã–π, –¥–µ–ª–æ–≤–æ–π
‚Ä¢ –ê–∫—Ü–µ–Ω—Ç –Ω–∞ —Å—Ä–æ–∫–∏, —Å—Ç–æ–∏–º–æ—Å—Ç—å, —Ä–∏—Å–∫–∏
‚Ä¢ –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã
‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è

**–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:**
1. **–°—É—Ç—å** (–∫–æ—Ä–æ—Ç–∫–æ –æ –ø—Ä–æ–±–ª–µ–º–µ)
2. **–†–∏—Å–∫–∏** (—á—Ç–æ –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ –Ω–µ —Ç–∞–∫)
3. **–†–µ—à–µ–Ω–∏—è** (–≤–∞—Ä–∏–∞–Ω—Ç—ã —Å –ø–ª—é—Å–∞–º–∏/–º–∏–Ω—É—Å–∞–º–∏)
4. **–°—Ä–æ–∫–∏ –∏ –∑–∞—Ç—Ä–∞—Ç—ã** (—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –¥–µ–Ω–µ–≥)
5. **–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã** (–ì–ö –†–§, –¥–æ–≥–æ–≤–æ—Ä–∞)

**–ü–†–ò–û–†–ò–¢–ï–¢–´:**
üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞
‚è±Ô∏è –°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
‚öñÔ∏è –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏
üìä KPI –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å

**–ü–†–ò–ú–ï–†–´ –í–û–ü–†–û–°–û–í:**
‚Ä¢ "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —É—Å—Ç—Ä–∞–Ω–∏—Ç—å –¥–µ—Ñ–µ–∫—Ç—ã?"
‚Ä¢ "–ú–æ–∂–µ–º –ª–∏ –º—ã —Ä–∞—Å—Ç–æ—Ä–≥–Ω—É—Ç—å –¥–æ–≥–æ–≤–æ—Ä —Å –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–º?"
‚Ä¢ "–ö–∞–∫ —É—Å–∫–æ—Ä–∏—Ç—å —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ?"
"""

    elif role_id == "student":
        return f"""{base_prompt}

**–í–ê–®–ê –†–û–õ–¨: –ü–†–ï–ü–û–î–ê–í–ê–¢–ï–õ–¨/–ù–ê–°–¢–ê–í–ù–ò–ö –î–õ–Ø –ù–û–í–ò–ß–ö–ê**

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî —Å—Ç—É–¥–µ–Ω—Ç –∏–ª–∏ –Ω–∞—á–∏–Ω–∞—é—â–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç. –í–∞—à–∏ –∑–∞–¥–∞—á–∏:

**–°–¢–ò–õ–¨ –û–¢–í–ï–¢–û–í:**
‚Ä¢ –ü—Ä–æ—Å—Ç–æ–π —è–∑—ã–∫ –±–µ–∑ –∂–∞—Ä–≥–æ–Ω–∞
‚Ä¢ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–æ–≤
‚Ä¢ –ê–Ω–∞–ª–æ–≥–∏–∏ –∏ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –∂–∏–∑–Ω–∏
‚Ä¢ –ü–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

**–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:**
1. **–ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏** (—Å—É—Ç—å –±–µ–∑ —Ç–µ—Ä–º–∏–Ω–æ–≤)
2. **–¢–µ—Ä–º–∏–Ω—ã** (—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–ª–æ–≤)
3. **–ê–Ω–∞–ª–æ–≥–∏—è** (–ø–æ—Ö–æ–∂–µ–µ –∏–∑ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏)
4. **–ü—Ä–∏–º–µ—Ä** (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è)
5. **–ß—Ç–æ –ø–æ—á–∏—Ç–∞—Ç—å** (—É—á–µ–±–Ω–∏–∫–∏, –≤–∏–¥–µ–æ)

**–ü–†–ò–û–†–ò–¢–ï–¢–´:**
üìñ –û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å
üí° –ü–æ–Ω—è—Ç–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
üéØ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–ª—å–∑–∞
üìö –°—Å—ã–ª–∫–∏ –Ω–∞ —É—á–µ–±–Ω–∏–∫–∏

**–ü–†–ò–ú–ï–†–´ –í–û–ü–†–û–°–û–í:**
‚Ä¢ "–ß—Ç–æ —Ç–∞–∫–æ–µ –°–ù–∏–ü?"
‚Ä¢ "–ó–∞—á–µ–º –Ω—É–∂–Ω–∞ –∞—Ä–º–∞—Ç—É—Ä–∞ –≤ –±–µ—Ç–æ–Ω–µ?"
‚Ä¢ "–ö–∞–∫ —á–∏—Ç–∞—Ç—å —á–µ—Ä—Ç–µ–∂–∏?"
"""

    else:  # universal
        return f"""{base_prompt}

**–í–ê–®–ê –†–û–õ–¨: –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –ü–û–ú–û–©–ù–ò–ö**

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ —Å—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞ –ø–æ–¥ –≤–æ–ø—Ä–æ—Å:

‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å ‚Üí –æ—Ç–≤–µ—á–∞–π—Ç–µ –∫–∞–∫ –ø—Ä–æ—Ä–∞–±—É
‚Ä¢ –†–∞—Å—á—ë—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å ‚Üí –æ—Ç–≤–µ—á–∞–π—Ç–µ –∫–∞–∫ –ì–ò–ü—É
‚Ä¢ –í–æ–ø—Ä–æ—Å –æ –∫–æ–Ω—Ç—Ä–æ–ª–µ ‚Üí –æ—Ç–≤–µ—á–∞–π—Ç–µ –∫–∞–∫ –∏–Ω–∂–µ–Ω–µ—Ä—É –û–¢–ö
‚Ä¢ –î–µ–ª–æ–≤–æ–π –≤–æ–ø—Ä–æ—Å ‚Üí –æ—Ç–≤–µ—á–∞–π—Ç–µ –∫–∞–∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä—É
‚Ä¢ –ë–∞–∑–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å ‚Üí –æ—Ç–≤–µ—á–∞–π—Ç–µ –∫–∞–∫ —Å—Ç—É–¥–µ–Ω—Ç—É

–û–ø—Ä–µ–¥–µ–ª—è–π—Ç–µ —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –≤–æ–ø—Ä–æ—Å—É –∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–π—Ç–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
"""


# ========================================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò
# ========================================

async def role_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /role - –≤—ã–±–æ—Ä —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""

    keyboard = create_role_selection_menu()

    # –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ä–æ–ª—å
    current_role = context.user_data.get('role', 'universal')
    current_role_name = ROLES.get(current_role, {}).get('name', '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π')

    await update.message.reply_text(
        f"üë§ **–í–´–ë–û–† –†–ï–ñ–ò–ú–ê –†–ê–ë–û–¢–´**\n\n"
        f"–¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: **{current_role_name}**\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É —Ä–æ–ª—å –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ —Å—Ç–∏–ª—è –æ—Ç–≤–µ—Ç–æ–≤:\n\n"
        f"üí° –ö–∞–∂–¥–∞—è —Ä–æ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–¥ –µ—ë –∑–∞–¥–∞—á–∏.",
        reply_markup=keyboard,
        parse_mode='Markdown'
    )


async def handle_role_selection(update: Update, context: ContextTypes.DEFAULT_TYPE, role_id: str):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏"""

    query = update.callback_query
    await query.answer()

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–æ–ª—å –≤ user_data
    context.user_data['role'] = role_id

    role_data = ROLES.get(role_id, {})
    role_name = role_data.get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ä–æ–ª—å')
    role_description = role_data.get('description', '')

    await query.edit_message_text(
        f"‚úÖ **–†–µ–∂–∏–º –∏–∑–º–µ–Ω—ë–Ω!**\n\n"
        f"–¢–µ–ø–µ—Ä—å –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ –≤ —Ä–µ–∂–∏–º–µ:\n"
        f"**{role_name}**\n\n"
        f"_{role_description}_\n\n"
        f"–í—Å–µ –º–æ–∏ –æ—Ç–≤–µ—Ç—ã –±—É–¥—É—Ç –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ —ç—Ç—É —Ä–æ–ª—å.\n\n"
        f"üí° –î–ª—è —Å–º–µ–Ω—ã —Ä–µ–∂–∏–º–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /role",
        parse_mode='Markdown'
    )

    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {update.effective_user.id} –≤—ã–±—Ä–∞–ª —Ä–æ–ª—å: {role_id}")


def get_user_role(context: ContextTypes.DEFAULT_TYPE) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    return context.user_data.get('role', 'universal')


def get_role_info(role_id: str) -> dict:
    """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–æ–ª–∏"""
    return ROLES.get(role_id, ROLES['universal'])
