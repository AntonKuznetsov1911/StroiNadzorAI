# üé§ Real-time Streaming - –í—ã—Å—à–∏–π –ø–∏–ª–æ—Ç–∞–∂!

## üöÄ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### **WebSocket Proxy –°–µ—Ä–≤–µ—Ä** (`websocket_proxy.py`)

‚úÖ **–î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π —Å—Ç—Ä–∏–º–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏**
- –ó–∞–¥–µ—Ä–∂–∫–∞ < 100ms (—Å–æ—Ç—ã–µ –¥–æ–ª–∏ —Å–µ–∫—É–Ω–¥—ã!)
- –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –∞—É–¥–∏–æ —Ç—É–¥–∞-–æ–±—Ä–∞—Ç–Ω–æ
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ interruption (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–±–∏–≤–∞—Ç—å –±–æ—Ç–∞)

‚úÖ **Function Calling –≤–æ –≤—Ä–µ–º—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞**
- `calculate_concrete` - —Ä–∞—Å—á—ë—Ç –±–µ—Ç–æ–Ω–∞ –Ω–∞ –ª–µ—Ç—É
- `search_regulation` - –ø–æ–∏—Å–∫ –ø–æ –°–ü/–ì–û–°–¢

‚úÖ **Production ready**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- Graceful shutdown
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Railway/Heroku

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Telegram Mini App       ‚îÇ
‚îÇ (–º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ WebSocket
             ‚îÇ –ê—É–¥–∏–æ —á–∞–Ω–∫–∏ (100ms)
             ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ websocket_proxy.py      ‚îÇ
‚îÇ (—ç—Ç–æ—Ç –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ WebSocket
             ‚îÇ PCM 16kHz
             ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Gemini Live API         ‚îÇ
‚îÇ (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º   ‚îÇ
‚îÇ  –≤—Ä–µ–º–µ–Ω–∏)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ WebSocket
             ‚îÇ –ê—É–¥–∏–æ –æ—Ç–≤–µ—Ç—ã
             ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ websocket_proxy.py      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ WebSocket
             ‚îÇ –ê—É–¥–∏–æ + —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è
             ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Telegram Mini App       ‚îÇ
‚îÇ (–¥–∏–Ω–∞–º–∏–∫, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß –ó–∞–ø—É—Å–∫ –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞

### –õ–æ–∫–∞–ª—å–Ω–æ:
```bash
cd C:\Users\PC\StroiNadzorAI
python websocket_proxy.py
```

### –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ (Railway):
```bash
# –ü—Ä–æ–∫—Å–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –ø–æ—Ä—Ç—É –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π PORT
```

### URL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:
```
wss://your-server:8080/stream/{user_id}
```

## üì± Telegram Mini App (Frontend)

### –ß—Ç–æ –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:

#### 1. **–ó–∞—Ö–≤–∞—Ç –∞—É–¥–∏–æ —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞**
```javascript
navigator.mediaDevices.getUserMedia({ audio: true })
  .then(stream => {
    const mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = (event) => {
      // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–∞–Ω–∫–æ–≤ —á–µ—Ä–µ–∑ WebSocket
      socket.send(event.data);
    };
    mediaRecorder.start(100); // –ö–∞–∂–¥—ã–µ 100–º—Å
  });
```

#### 2. **WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ**
```javascript
const socket = new WebSocket('wss://your-server/stream/USER_ID');

socket.onmessage = (event) => {
  if (event.data instanceof Blob) {
    // –ê—É–¥–∏–æ –¥–∞–Ω–Ω—ã–µ - –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
    playAudio(event.data);
  } else {
    // JSON - —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∏–ª–∏ —Å—Ç–∞—Ç—É—Å
    const data = JSON.parse(event.data);
    if (data.type === 'transcript') {
      displayText(data.text);
    }
  }
};
```

#### 3. **VAD (Voice Activity Detection)**
```javascript
// –ê–Ω–∞–ª–∏–∑ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ—á–∏
const analyser = audioContext.createAnalyser();
const dataArray = new Uint8Array(analyser.frequencyBinCount);

function detectVoice() {
  analyser.getByteFrequencyData(dataArray);
  const average = dataArray.reduce((a, b) => a + b) / dataArray.length;

  if (average > THRESHOLD) {
    // –ì–æ–ª–æ—Å –æ–±–Ω–∞—Ä—É–∂–µ–Ω - –Ω–∞—á–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É
    startStreaming();
  } else {
    // –¢–∏—à–∏–Ω–∞ - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
    stopStreaming();
  }
}
```

#### 4. **–®—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ**
```javascript
// –§–∏–ª—å—Ç—Ä –¥–ª—è —Å—Ç—Ä–æ–π–ø–ª–æ—â–∞–¥–∫–∏
const noiseFilter = audioContext.createBiquadFilter();
noiseFilter.type = 'highpass';
noiseFilter.frequency.value = 200; // –£–±–∏—Ä–∞–µ—Ç –Ω–∏–∑–∫–æ—á–∞—Å—Ç–æ—Ç–Ω—ã–π —à—É–º

microphone.connect(noiseFilter);
noiseFilter.connect(analyser);
```

#### 5. **Interruption support**
```javascript
// –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª –≥–æ–≤–æ—Ä–∏—Ç—å
function onUserSpeech() {
  // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –±–æ—Ç–∞
  audioElement.pause();
  audioElement.currentTime = 0;

  // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É interruption
  socket.send(JSON.dumps({
    type: 'interrupt'
  }));
}
```

## üéØ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–æ–π–ø–ª–æ—â–∞–¥–∫–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π —Ä–∞–±–æ—Ç—ã:

1. **–ò–Ω–∂–µ–Ω–µ—Ä –∏–¥—ë—Ç –ø–æ –æ–±—ä–µ–∫—Ç—É** –≤ –∫–∞—Å–∫–µ —Å –≥–∞—Ä–Ω–∏—Ç—É—Ä–æ–π
2. **–û—Ç–∫—Ä—ã–≤–∞–µ—Ç Mini App** –≤ Telegram
3. **–ù–∞–∂–∏–º–∞–µ—Ç "–ù–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä"**
4. **–ì–æ–≤–æ—Ä–∏—Ç –≥–æ–ª–æ—Å–æ–º**: *"–°–ª—É—à–∞–π, –ø—Ä–æ–≤–µ—Ä—å –ø–æ —á–µ—Ä—Ç–µ–∂—É, –∫–∞–∫–æ–π —à–∞–≥ –∞—Ä–º–∞—Ç—É—Ä—ã –≤ —ç—Ç–æ–π –∫–æ–ª–æ–Ω–Ω–µ?"*
5. **–ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –ú–ì–ù–û–í–ï–ù–ù–û** (< 100ms): *"–®–∞–≥ –∞—Ä–º–∞—Ç—É—Ä—ã 200 –º–∏–ª–ª–∏–º–µ—Ç—Ä–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ —á–µ—Ä—Ç–µ–∂—É –ª–∏—Å—Ç 5"*
6. **–ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∏–¥—Ç–∏ –∏ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å** –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

- ‚úÖ **–†—É–∫–∏ —Å–≤–æ–±–æ–¥–Ω—ã** - –º–æ–∂–Ω–æ –¥–µ—Ä–∂–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç/–ø–ª–∞–Ω—à–µ—Ç
- ‚úÖ **–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã** - –∫–∞–∫ —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –∫–æ–ª–ª–µ–≥–æ–π
- ‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç –≤ —à—É–º–µ** - —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è —Å—Ç—Ä–æ–π–∫–∏
- ‚úÖ **–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–±–∏—Ç—å** - –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—á—ë—Ç—ã** - Function Calling

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–±—ã—á–Ω—ã–µ –≥–æ–ª–æ—Å–æ–≤—ã–µ | –ù–∞—à Real-time Streaming |
|----------|-------------------|-------------------------|
| –ó–∞–¥–µ—Ä–∂–∫–∞ | 500-1000ms | < 100ms ‚ö° |
| Interruption | ‚ùå | ‚úÖ –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–±–∏–≤–∞—Ç—å |
| –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è | –ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è | –í —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ |
| –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ã | ‚ùå | ‚úÖ –ù–∞ –ª–µ—Ç—É |
| –®—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ | ‚ùå | ‚úÖ –î–ª—è —Å—Ç—Ä–æ–π–∫–∏ |
| VAD | ‚ùå | ‚úÖ –≠–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤ |

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Telegram Mini App:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Telegram Web App API
- –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- HTTPS –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω

### WebSocket Proxy:
- –í–∞–ª–∏–¥–∞—Ü–∏—è user_id
- Rate limiting (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

## üêõ Troubleshooting

### –ü—Ä–æ–∫—Å–∏ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ GOOGLE_API_KEY
echo $GOOGLE_API_KEY

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç
netstat -an | grep 8080
```

### –ù–µ—Ç –∑–≤—É–∫–∞ –≤ Mini App:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ HTTPS (HTTP –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å getUserMedia)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤ DevTools

### –í—ã—Å–æ–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞:
- –£–º–µ–Ω—å—à–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª MediaRecorder (50ms –≤–º–µ—Å—Ç–æ 100ms)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä

## üìù TODO (—Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏)

- [ ] –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—ã–π frontend Mini App
- [ ] –î–æ–±–∞–≤–∏—Ç—å UI –¥–ª—è —Å—Ç—Ä–æ–π–ø–ª–æ—â–∞–¥–∫–∏
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å offline —Ä–µ–∂–∏–º (–∫—ç—à –æ—Ç–≤–µ—Ç–æ–≤)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å bot.py (–∫–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ Mini App)

## üöÄ Deployment

### Railway:
1. –î–æ–±–∞–≤–∏—Ç—å `websocket_proxy.py` –≤ `Procfile`:
   ```
   web: python websocket_proxy.py
   ```

2. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
   ```
   GOOGLE_API_KEY=your_key
   PORT=8080
   ```

### Vercel (–¥–ª—è Mini App frontend):
```bash
vercel deploy mini_app/
```

---

**–í–µ—Ä—Å–∏—è**: Real-time v1.0
**–î–∞—Ç–∞**: –î–µ–∫–∞–±—Ä—å 2025
**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏**: WebSocket, Gemini Live API, Telegram Mini App
**–ó–∞–¥–µ—Ä–∂–∫–∞**: < 100ms
